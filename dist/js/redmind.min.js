Function.prototype.bind||(Function.prototype.bind=function(t){var e=this,i=Array.prototype.slice.call(arguments,1);return function(){return e.apply(t,i.concat(Array.prototype.slice.call(arguments)))}});var MM={_subscribers:{},publish:function(t,e,i){var n=this._subscribers[t]||[];n.forEach(function(n){n.handleMessage(t,e,i)})},subscribe:function(t,e){t in this._subscribers||(this._subscribers[t]=[]);var i=this._subscribers[t].indexOf(e);i==-1&&this._subscribers[t].push(e)},unsubscribe:function(t,e){var i=this._subscribers[t].indexOf(e);i>-1&&this._subscribers[t].splice(i,1)},generateId:function(){for(var t="",e=0;e<8;e++){var i=Math.floor(26*Math.random());t+=String.fromCharCode("a".charCodeAt(0)+i)}return t}},Promise=function(){this._state=0,this._value=null,this._cb={fulfilled:[],rejected:[]},this._thenPromises=[]};Promise.prototype.then=function(t,e){this._cb.fulfilled.push(t),this._cb.rejected.push(e);var i=new Promise;return this._thenPromises.push(i),this._state>0&&setTimeout(this._processQueue.bind(this),0),i},Promise.prototype.fulfill=function(t){return 0!=this._state?this:(this._state=1,this._value=t,this._processQueue(),this)},Promise.prototype.reject=function(t){return 0!=this._state?this:(this._state=2,this._value=t,this._processQueue(),this)},Promise.prototype.chain=function(t){return this.then(t.fulfill.bind(t),t.reject.bind(t))},Promise.prototype.catch=function(t){return this.then(null,t)},Promise.prototype._processQueue=function(){for(;this._thenPromises.length;){var t=this._cb.fulfilled.shift(),e=this._cb.rejected.shift();this._executeCallback(1==this._state?t:e)}},Promise.prototype._executeCallback=function(t){var e=this._thenPromises.shift();if("function"!=typeof t)return void(1==this._state?e.fulfill(this._value):e.reject(this._value));try{var i=t(this._value);if(i&&"function"==typeof i.then){var n=function(t){e.fulfill(t)},o=function(t){e.reject(t)};i.then(n,o)}else e.fulfill(i)}catch(t){e.reject(t)}},Promise.all=Promise.when=function(t){for(var e=new this,i=0,n=[],o=0;o<t.length;o++)i++,t[o].then(function(t,o){n[t]=o,i--,i||e.fulfill(n)}.bind(null,o),function(t){i=1/0,e.reject(t)});return e},Promise.setTimeout=function(t){var e=new this;return setTimeout(function(){e.fulfill()},t),e},Promise.event=function(t,e,i){var n=new this,o=function(a){t.removeEventListener(e,o,i),n.fulfill(a)};return t.addEventListener(e,o,i),n},Promise.transition=function(t){return"transition"in t.style?this.event(t,"transitionend",!1):"webkitTransition"in t.style?this.event(t,"webkitTransitionEnd",!1):(new this).fulfill()},Promise.send=function(t,e){var i=new this;return t.addEventListener("readystatechange",function(t){4==t.target.readyState&&("2"==t.target.status.toString().charAt(0)?i.fulfill(t.target):i.reject(t.target))}),t.send(e),i},Promise.worker=function(t,e){var i=new this,n=new Worker(t);return Promise.event(n,"message").then(function(t){i.fulfill(t.data)}),Promise.event(n,"error").then(function(t){i.reject(t.message)}),n.postMessage(e),i},MM.Repo={id:"",label:"",getAll:function(){var t=[];for(var e in this){var i=this[e];this.isPrototypeOf(i)&&t.push(i)}return t},getByProperty:function(t,e){return this.getAll().filter(function(i){return i[t]==e})[0]||null},getById:function(t){return this.getByProperty("id",t)},buildOption:function(){var t=document.createElement("option");return t.value=this.id,t.innerHTML=this.label,t}},MM.Item=function(){this._parent=null,this._children=[],this._collapsed=!1,this._layout=null,this._shape=null,this._autoShape=!0,this._color=null,this._value=null,this._status=null,this._side=null,this._id=MM.generateId(),this._oldText="",this._computed={value:0,status:null},this._dom={node:document.createElement("li"),content:document.createElement("div"),status:document.createElement("span"),value:document.createElement("span"),text:document.createElement("div"),children:document.createElement("ul"),toggle:document.createElement("div"),canvas:document.createElement("canvas")},this._dom.node.classList.add("item"),this._dom.content.classList.add("content"),this._dom.status.classList.add("status"),this._dom.value.classList.add("value"),this._dom.text.classList.add("text"),this._dom.toggle.classList.add("toggle"),this._dom.children.classList.add("children"),this._dom.content.appendChild(this._dom.text),this._dom.node.appendChild(this._dom.canvas),this._dom.node.appendChild(this._dom.content),this._dom.toggle.addEventListener("click",this)},MM.Item.COLOR="#999",MM.Item.RE=/\b(([a-z][\w-]+:\/\/\w)|(([\w-]+\.){2,}[a-z][\w-]+)|([\w-]+\.[a-z][\w-]+\/))[^\s]*([^\s,.;:?!<>\(\)\[\]'"])?($|\b)/i,MM.Item.fromJSON=function(t){return(new this).fromJSON(t)},MM.Item.prototype.toJSON=function(){var t={id:this._id,text:this.getText()};return this._side&&(t.side=this._side),this._color&&(t.color=this._color),this._value&&(t.value=this._value),this._status&&(t.status=this._status),this._layout&&(t.layout=this._layout.id),this._autoShape||(t.shape=this._shape.id),this._collapsed&&(t.collapsed=1),this._children.length&&(t.children=this._children.map(function(t){return t.toJSON()})),t},MM.Item.prototype.fromJSON=function(t){return this.setText(t.text),t.id&&(this._id=t.id),t.side&&(this._side=t.side),t.color&&(this._color=t.color),t.value&&(this._value=t.value),t.status&&(this._status=t.status,"maybe"==this._status&&(this._status="computed")),t.collapsed&&this.collapse(),t.layout&&(this._layout=MM.Layout.getById(t.layout)),t.shape&&this.setShape(MM.Shape.getById(t.shape)),(t.children||[]).forEach(function(t){this.insertChild(MM.Item.fromJSON(t))},this),this},MM.Item.prototype.mergeWith=function(t){var e=0;this.getText()==t.text||this._dom.text.contentEditable||this.setText(t.text),this._side!=t.side&&(this._side=t.side,e=1),this._color!=t.color&&(this._color=t.color,e=2),this._value!=t.value&&(this._value=t.value,e=1),this._status!=t.status&&(this._status=t.status,e=1),this._collapsed!=!!t.collapsed&&this[this._collapsed?"expand":"collapse"](),this.getOwnLayout()!=t.layout&&(this._layout=MM.Layout.getById(t.layout),e=2);var i=this._autoShape?null:this._shape.id;i!=t.shape&&this.setShape(MM.Shape.getById(t.shape)),(t.children||[]).forEach(function(t,e){if(e>=this._children.length)this.insertChild(MM.Item.fromJSON(t));else{var i=this._children[e];i.getId()==t.id?i.mergeWith(t):(this.removeChild(this._children[e]),this.insertChild(MM.Item.fromJSON(t),e))}},this);for(var n=(t.children||[]).length;this._children.length>n;)this.removeChild(this._children[this._children.length-1]);1==e&&this.update(),2==e&&this.updateSubtree()},MM.Item.prototype.clone=function(){var t=this.toJSON(),e=function(t){delete t.id,t.children&&t.children.forEach(e)};return e(t),this.constructor.fromJSON(t)},MM.Item.prototype.select=function(){this._dom.node.classList.add("current"),this.getMap().ensureItemVisibility(this),MM.Clipboard.focus(),MM.publish("item-select",this)},MM.Item.prototype.deselect=function(){MM.App.editing&&MM.Command.Finish.execute(),this._dom.node.classList.remove("current")},MM.Item.prototype.update=function(t){var e=this.getMap();if(!e||!e.isVisible())return this;if(MM.publish("item-change",this),this._autoShape){var i=this._getAutoShape();i!=this._shape&&(this._shape&&this._shape.unset(this),this._shape=i,this._shape.set(this))}return this._updateStatus(),this._updateValue(),this._dom.node.classList[this._collapsed?"add":"remove"]("collapsed"),this.getLayout().update(this),this.getShape().update(this),this.isRoot()||t||this._parent.update(),this},MM.Item.prototype.updateSubtree=function(t){return this._children.forEach(function(t){t.updateSubtree(!0)}),this.update(t)},MM.Item.prototype.setText=function(t){return this._dom.text.innerHTML=t,this._findLinks(this._dom.text),this.update()},MM.Item.prototype.getId=function(){return this._id},MM.Item.prototype.getText=function(){return this._dom.text.innerHTML},MM.Item.prototype.collapse=function(){if(!this._collapsed)return this._collapsed=!0,this.update()},MM.Item.prototype.expand=function(){if(this._collapsed)return this._collapsed=!1,this.update(),this.updateSubtree()},MM.Item.prototype.isCollapsed=function(){return this._collapsed},MM.Item.prototype.setValue=function(t){return this._value=t,this.update()},MM.Item.prototype.getValue=function(){return this._value},MM.Item.prototype.getComputedValue=function(){return this._computed.value},MM.Item.prototype.setStatus=function(t){return this._status=t,this.update()},MM.Item.prototype.getStatus=function(){return this._status},MM.Item.prototype.getComputedStatus=function(){return this._computed.status},MM.Item.prototype.setSide=function(t){return this._side=t,this},MM.Item.prototype.getSide=function(){return this._side},MM.Item.prototype.getChildren=function(){return this._children},MM.Item.prototype.setColor=function(t){return this._color=t,this.updateSubtree()},MM.Item.prototype.getColor=function(){return this._color||(this.isRoot()?MM.Item.COLOR:this._parent.getColor())},MM.Item.prototype.getOwnColor=function(){return this._color},MM.Item.prototype.getLayout=function(){return this._layout||this._parent.getLayout()},MM.Item.prototype.getOwnLayout=function(){return this._layout},MM.Item.prototype.setLayout=function(t){return this._layout=t,this.updateSubtree()},MM.Item.prototype.getShape=function(){return this._shape},MM.Item.prototype.getOwnShape=function(){return this._autoShape?null:this._shape},MM.Item.prototype.setShape=function(t){return this._shape&&this._shape.unset(this),t?(this._autoShape=!1,this._shape=t):(this._autoShape=!0,this._shape=this._getAutoShape()),this._shape.set(this),this.update()},MM.Item.prototype.getDOM=function(){return this._dom},MM.Item.prototype.getMap=function(){for(var t=this._parent;t;){if(t instanceof MM.Map)return t;t=t.getParent()}return null},MM.Item.prototype.getParent=function(){return this._parent},MM.Item.prototype.isRoot=function(){return this._parent instanceof MM.Map},MM.Item.prototype.setParent=function(t){return this._parent=t,this.updateSubtree()},MM.Item.prototype.insertChild=function(t,e){var i=!1;t?t.getParent()&&t.getParent().removeChild&&t.getParent().removeChild(t):(t=new MM.Item,i=!0),this._children.length||(this._dom.node.appendChild(this._dom.toggle),this._dom.node.appendChild(this._dom.children)),arguments.length<2&&(e=this._children.length);var n=null;return e<this._children.length&&(n=this._children[e].getDOM().node),this._dom.children.insertBefore(t.getDOM().node,n),this._children.splice(e,0,t),t.setParent(this)},MM.Item.prototype.removeChild=function(t){var e=this._children.indexOf(t);this._children.splice(e,1);var i=t.getDOM().node;return i.parentNode.removeChild(i),t.setParent(null),this._children.length||(this._dom.toggle.parentNode.removeChild(this._dom.toggle),this._dom.children.parentNode.removeChild(this._dom.children)),this.update()},MM.Item.prototype.startEditing=function(){return this._oldText=this.getText(),this._dom.text.contentEditable=!0,this._dom.text.focus(),document.execCommand("styleWithCSS",null,!1),this._dom.text.addEventListener("input",this),this._dom.text.addEventListener("keydown",this),this._dom.text.addEventListener("blur",this),this},MM.Item.prototype.stopEditing=function(){this._dom.text.removeEventListener("input",this),this._dom.text.removeEventListener("keydown",this),this._dom.text.removeEventListener("blur",this),this._dom.text.blur(),this._dom.text.contentEditable=!1;var t=this._dom.text.innerHTML;return this._dom.text.innerHTML=this._oldText,this._oldText="",this.update(),MM.Clipboard.focus(),t},MM.Item.prototype.handleEvent=function(t){switch(t.type){case"input":this.update(),this.getMap().ensureItemVisibility(this);break;case"keydown":9==t.keyCode&&t.preventDefault();break;case"blur":MM.Command.Finish.execute();break;case"click":this._collapsed?this.expand():this.collapse(),MM.App.select(this)}},MM.Item.prototype._getAutoShape=function(){for(var t=0,e=this;!e.isRoot();)t++,e=e.getParent();switch(t){case 0:return MM.Shape.Ellipse;case 1:return MM.Shape.Box;default:return MM.Shape.Underline}},MM.Item.prototype._updateStatus=function(){this._dom.status.className="status",this._dom.status.style.display="";var t=this._status;if("computed"==this._status){var e=this._children.every(function(t){return t.getComputedStatus()!==!1});t=e?"yes":"no"}switch(t){case"yes":this._dom.status.classList.add("yes"),this._computed.status=!0;break;case"no":this._dom.status.classList.add("no"),this._computed.status=!1;break;default:this._computed.status=null,this._dom.status.style.display="none"}},MM.Item.prototype._updateValue=function(){if(this._dom.value.style.display="","number"==typeof this._value)return this._computed.value=this._value,void(this._dom.value.innerHTML=this._value);var t=this._children.map(function(t){return t.getComputedValue()}),e=0;switch(this._value){case"sum":e=t.reduce(function(t,e){return t+e},0);break;case"avg":var i=t.reduce(function(t,e){return t+e},0);e=t.length?i/t.length:0;break;case"max":e=Math.max.apply(Math,t);break;case"min":e=Math.min.apply(Math,t);break;default:return this._computed.value=0,this._dom.value.innerHTML="",void(this._dom.value.style.display="none")}this._computed.value=e,this._dom.value.innerHTML=Math.round(e)==e?e:e.toFixed(3)},MM.Item.prototype._findLinks=function(t){for(var e=[].slice.call(t.childNodes),i=0;i<e.length;i++){var n=e[i];switch(n.nodeType){case 1:if("a"==n.nodeName.toLowerCase())continue;this._findLinks(n);break;case 3:var o=n.nodeValue.match(this.constructor.RE);if(o){var a=n.nodeValue.substring(0,o.index),r=n.nodeValue.substring(o.index+o[0].length),s=document.createElement("a");s.innerHTML=s.href=o[0],a&&t.insertBefore(document.createTextNode(a),n),t.insertBefore(s,n),r?(n.nodeValue=r,i--):t.removeChild(n)}}}},MM.Map=function(t){var e={root:"My Mind Map",layout:MM.Layout.Map};for(var i in t)e[i]=t[i];this._root=null,this._visible=!1,this._position=[0,0],this._setRoot((new MM.Item).setText(e.root).setLayout(e.layout))},MM.Map.fromJSON=function(t){return(new this).fromJSON(t)},MM.Map.prototype.toJSON=function(){var t={root:this._root.toJSON()};return t},MM.Map.prototype.fromJSON=function(t){return this._setRoot(MM.Item.fromJSON(t.root)),this},MM.Map.prototype.mergeWith=function(t){for(var e=[],i=MM.App.current,n=i;n!=this;)e.push(n.getId()),n=n.getParent();if(this._root.mergeWith(t.root),i.getMap()){for(var n=i.getParent(),o=!1;n!=this;)n.isCollapsed()&&(o=!0),n=n.getParent();if(!o)return}MM.App.editing&&i.stopEditing();var a={},r=function(t){a[t.getId()]=t,t.getChildren().forEach(r)};for(r(this._root);e.length;){var s=e.shift();if(s in a)return void MM.App.select(a[s])}},MM.Map.prototype.isVisible=function(){return this._visible},MM.Map.prototype.update=function(){return this._root.updateSubtree(),this},MM.Map.prototype.show=function(t){var e=this._root.getDOM().node;return t.appendChild(e),this._visible=!0,this._root.updateSubtree(),this.center(),MM.App.select(this._root),this},MM.Map.prototype.hide=function(){var t=this._root.getDOM().node;return t.parentNode.removeChild(t),this._visible=!1,this},MM.Map.prototype.center=function(){var t=this._root.getDOM().node,e=MM.App.portSize,i=(e[0]-t.offsetWidth)/2,n=(e[1]-t.offsetHeight)/2;return this._moveTo(Math.round(i),Math.round(n)),this},MM.Map.prototype.moveBy=function(t,e){return this._moveTo(this._position[0]+t,this._position[1]+e)},MM.Map.prototype.getClosestItem=function(t,e){var i=[],n=function(o){var a=o.getDOM().content.getBoundingClientRect(),r=a.left+a.width/2-t,s=a.top+a.height/2-e;i.push({item:o,dx:r,dy:s}),o.isCollapsed()||o.getChildren().forEach(n)};return n(this._root),i.sort(function(t,e){var i=t.dx*t.dx+t.dy*t.dy,n=e.dx*e.dx+e.dy*e.dy;return i-n}),i[0]},MM.Map.prototype.getItemFor=function(t){for(var e=this._root.getDOM().node.parentNode;t!=e&&!t.classList.contains("content");)t=t.parentNode;if(t==e)return null;var i=function(t,e){if(t.getDOM().content==e)return t;for(var n=t.getChildren(),o=0;o<n.length;o++){var a=i(n[o],e);if(a)return a}return null};return i(this._root,t)},MM.Map.prototype.ensureItemVisibility=function(t){var e=10,i=t.getDOM().content,n=i.getBoundingClientRect(),o=this._root.getDOM().node,a=o.parentNode.getBoundingClientRect(),r=[0,0],s=a.left-n.left+e;s>0&&(r[0]=s);var s=a.right-n.right-e;s<0&&(r[0]=s);var h=a.top-n.top+e;h>0&&(r[1]=h);var h=a.bottom-n.bottom-e;h<0&&(r[1]=h),(r[0]||r[1])&&this.moveBy(r[0],r[1])},MM.Map.prototype.getParent=function(){return null},MM.Map.prototype.getRoot=function(){return this._root},MM.Map.prototype.getName=function(){var t=this._root.getText();return MM.Format.br2nl(t).replace(/\n/g," ").replace(/<.*?>/g,"").trim()},MM.Map.prototype.getId=function(){return this._root.getId()},MM.Map.prototype.pick=function(t,e){var i=[],n=t.getDOM().content.getBoundingClientRect();return this._getPickCandidates(n,this._root,e,i),i.length?(i.sort(function(t,e){return t.dist-e.dist}),i[0].item):t},MM.Map.prototype._getPickCandidates=function(t,e,i,n){e.isCollapsed()||e.getChildren().forEach(function(e){this._getPickCandidates(t,e,i,n)},this);var o=e.getDOM().content,a=o.getBoundingClientRect();if("left"==i||"right"==i){var r=t.left+t.width/2,s=a.left+a.width/2;if("left"==i&&s>r)return;if("right"==i&&s<r)return;var h=t.top-a.bottom,l=a.top-t.bottom,c=Math.abs(s-r)}else{var d=t.top+t.height/2,u=a.top+a.height/2;if("top"==i&&u>d)return;if("bottom"==i&&u<d)return;var h=t.left-a.right,l=a.left-t.right,c=Math.abs(u-d)}var M=Math.max(h,l);M>0||!c||c<M||n.push({item:e,dist:c})},MM.Map.prototype._moveTo=function(t,e){this._position=[t,e];var i=this._root.getDOM().node;i.style.left=t+"px",i.style.top=e+"px"},MM.Map.prototype._setRoot=function(t){this._root=t,this._root.setParent(this)},MM.Keyboard={},MM.Keyboard.init=function(){window.addEventListener("keydown",this),window.addEventListener("keypress",this)},MM.Keyboard.handleEvent=function(t){for(var e=document.activeElement;e&&e!=document;){if(e.classList.contains("ui"))return;e=e.parentNode}for(var i=MM.Command.getAll(),n=0;n<i.length;n++){var o=i[n];if(o.isValid())for(var a=o.keys,r=0;r<a.length;r++)if(this._keyOK(a[r],t))return o.prevent&&t.preventDefault(),void o.execute(t)}},MM.Keyboard._keyOK=function(t,e){if("keyCode"in t&&"keydown"!=e.type)return!1;if("charCode"in t&&"keypress"!=e.type)return!1;for(var i in t)if(t[i]!=e[i])return!1;return!0},MM.Tip={_node:null,handleEvent:function(){this._hide()},handleMessage:function(){this._hide()},init:function(){this._node=document.querySelector("#tip"),this._node.addEventListener("click",this),MM.subscribe("command-child",this),MM.subscribe("command-sibling",this)},_hide:function(){MM.unsubscribe("command-child",this),MM.unsubscribe("command-sibling",this),this._node.removeEventListener("click",this),this._node.classList.add("hidden"),this._node=null}},MM.Action=function(){},MM.Action.prototype.perform=function(){},MM.Action.prototype.undo=function(){},MM.Action.Multi=function(t){this._actions=t},MM.Action.Multi.prototype=Object.create(MM.Action.prototype),MM.Action.Multi.prototype.perform=function(){this._actions.forEach(function(t){t.perform()})},MM.Action.Multi.prototype.undo=function(){this._actions.slice().reverse().forEach(function(t){t.undo()})},MM.Action.InsertNewItem=function(t,e){this._parent=t,this._index=e,this._item=new MM.Item},MM.Action.InsertNewItem.prototype=Object.create(MM.Action.prototype),MM.Action.InsertNewItem.prototype.perform=function(){this._parent.expand(),this._item=this._parent.insertChild(this._item,this._index),MM.App.select(this._item)},MM.Action.InsertNewItem.prototype.undo=function(){this._parent.removeChild(this._item),MM.App.select(this._parent)},MM.Action.AppendItem=function(t,e){this._parent=t,this._item=e},MM.Action.AppendItem.prototype=Object.create(MM.Action.prototype),MM.Action.AppendItem.prototype.perform=function(){this._parent.insertChild(this._item),MM.App.select(this._item)},MM.Action.AppendItem.prototype.undo=function(){this._parent.removeChild(this._item),MM.App.select(this._parent)},MM.Action.RemoveItem=function(t){this._item=t,this._parent=t.getParent(),this._index=this._parent.getChildren().indexOf(this._item)},MM.Action.RemoveItem.prototype=Object.create(MM.Action.prototype),MM.Action.RemoveItem.prototype.perform=function(){this._parent.removeChild(this._item),MM.App.select(this._parent)},MM.Action.RemoveItem.prototype.undo=function(){this._parent.insertChild(this._item,this._index),MM.App.select(this._item)},MM.Action.MoveItem=function(t,e,i,n){this._item=t,this._newParent=e,this._newIndex=arguments.length<3?null:i,this._newSide=n||"",this._oldParent=t.getParent(),this._oldIndex=this._oldParent.getChildren().indexOf(t),this._oldSide=t.getSide()},MM.Action.MoveItem.prototype=Object.create(MM.Action.prototype),MM.Action.MoveItem.prototype.perform=function(){this._item.setSide(this._newSide),null===this._newIndex?this._newParent.insertChild(this._item):this._newParent.insertChild(this._item,this._newIndex),MM.App.select(this._item)},MM.Action.MoveItem.prototype.undo=function(){this._item.setSide(this._oldSide),this._oldParent.insertChild(this._item,this._oldIndex),MM.App.select(this._newParent)},MM.Action.Swap=function(t,e){this._item=t,this._parent=t.getParent();var i=this._parent.getChildren(),n=this._parent.getLayout().pickSibling(this._item,e);this._sourceIndex=i.indexOf(this._item),this._targetIndex=i.indexOf(n)},MM.Action.Swap.prototype=Object.create(MM.Action.prototype),MM.Action.Swap.prototype.perform=function(){this._parent.insertChild(this._item,this._targetIndex)},MM.Action.Swap.prototype.undo=function(){this._parent.insertChild(this._item,this._sourceIndex)},MM.Action.SetLayout=function(t,e){this._item=t,this._layout=e,this._oldLayout=t.getOwnLayout()},MM.Action.SetLayout.prototype=Object.create(MM.Action.prototype),MM.Action.SetLayout.prototype.perform=function(){this._item.setLayout(this._layout)},MM.Action.SetLayout.prototype.undo=function(){this._item.setLayout(this._oldLayout)},MM.Action.SetShape=function(t,e){this._item=t,this._shape=e,this._oldShape=t.getOwnShape()},MM.Action.SetShape.prototype=Object.create(MM.Action.prototype),MM.Action.SetShape.prototype.perform=function(){this._item.setShape(this._shape)},MM.Action.SetShape.prototype.undo=function(){this._item.setShape(this._oldShape)},MM.Action.SetColor=function(t,e){this._item=t,this._color=e,this._oldColor=t.getOwnColor()},MM.Action.SetColor.prototype=Object.create(MM.Action.prototype),MM.Action.SetColor.prototype.perform=function(){this._item.setColor(this._color)},MM.Action.SetColor.prototype.undo=function(){this._item.setColor(this._oldColor)},MM.Action.SetText=function(t,e){this._item=t,this._text=e,this._oldText=t.getText(),this._oldValue=t.getValue()},MM.Action.SetText.prototype=Object.create(MM.Action.prototype),MM.Action.SetText.prototype.perform=function(){this._item.setText(this._text);var t=Number(this._text);t==this._text&&this._item.setValue(t)},MM.Action.SetText.prototype.undo=function(){this._item.setText(this._oldText),this._item.setValue(this._oldValue)},MM.Action.SetValue=function(t,e){this._item=t,this._value=e,this._oldValue=t.getValue()},MM.Action.SetValue.prototype=Object.create(MM.Action.prototype),MM.Action.SetValue.prototype.perform=function(){this._item.setValue(this._value)},MM.Action.SetValue.prototype.undo=function(){this._item.setValue(this._oldValue)},MM.Action.SetStatus=function(t,e){this._item=t,this._status=e,this._oldStatus=t.getStatus()},MM.Action.SetStatus.prototype=Object.create(MM.Action.prototype),MM.Action.SetStatus.prototype.perform=function(){this._item.setStatus(this._status)},MM.Action.SetStatus.prototype.undo=function(){this._item.setStatus(this._oldStatus)},MM.Action.SetSide=function(t,e){this._item=t,this._side=e,this._oldSide=t.getSide()},MM.Action.SetSide.prototype=Object.create(MM.Action.prototype),MM.Action.SetSide.prototype.perform=function(){this._item.setSide(this._side),this._item.getMap().update()},MM.Action.SetStatus.prototype.undo=function(){this._item.setSide(this._oldSide),this._item.getMap().update()},MM.Clipboard={_item:null,_mode:"",_delay:50,_node:document.createElement("textarea")},MM.Clipboard.init=function(){this._node.style.position="absolute",this._node.style.width=0,this._node.style.height=0,this._node.style.left="-100px",this._node.style.top="-100px",document.body.appendChild(this._node)},MM.Clipboard.focus=function(){this._node.focus(),this._empty()},MM.Clipboard.copy=function(t){this._endCut(),this._item=t.clone(),this._mode="copy",this._expose()},MM.Clipboard.paste=function(t){setTimeout(function(){var e=this._node.value;this._empty(),e&&(this._item&&e==MM.Format.Plaintext.to(this._item.toJSON())?this._pasteItem(this._item,t):this._pastePlaintext(e,t))}.bind(this),this._delay)},MM.Clipboard._pasteItem=function(t,e){switch(this._mode){case"cut":if(t==e||t.getParent()==e)return void this._endCut();for(var i=e;!i.isRoot();){if(i==t)return;i=i.getParent()}var n=new MM.Action.MoveItem(t,e);MM.App.action(n),this._endCut();break;case"copy":var n=new MM.Action.AppendItem(e,t.clone());MM.App.action(n)}},MM.Clipboard._pastePlaintext=function(t,e){"cut"==this._mode&&this._endCut();var i=MM.Format.Plaintext.from(t),n=MM.Map.fromJSON(i),o=n.getRoot();if(o.getText()){var a=new MM.Action.AppendItem(e,o);MM.App.action(a)}else{var r=o.getChildren().map(function(t){return new MM.Action.AppendItem(e,t)}),a=new MM.Action.Multi(r);MM.App.action(a)}},MM.Clipboard.cut=function(t){this._endCut(),this._item=t,this._item.getDOM().node.classList.add("cut"),this._mode="cut",this._expose()},MM.Clipboard._expose=function(){var t=this._item.toJSON(),e=MM.Format.Plaintext.to(t);this._node.value=e,this._node.selectionStart=0,this._node.selectionEnd=this._node.value.length,setTimeout(this._empty.bind(this),this._delay)},MM.Clipboard._empty=function(){this._node.value="\n",this._node.selectionStart=0,this._node.selectionEnd=this._node.value.length},MM.Clipboard._endCut=function(){"cut"==this._mode&&(this._item.getDOM().node.classList.remove("cut"),this._item=null,this._mode="")},MM.Menu={_dom:{},_port:null,open:function(t,e){this._dom.node.style.display="";var i=this._dom.node.offsetWidth,n=this._dom.node.offsetHeight,o=t,a=e;o>this._port.offsetWidth/2&&(o-=i),a>this._port.offsetHeight/2&&(a-=n),this._dom.node.style.left=o+"px",this._dom.node.style.top=a+"px"},close:function(){this._dom.node.style.display="none"},handleEvent:function(t){if(t.currentTarget!=this._dom.node)return void this.close();t.stopPropagation(),t.preventDefault();var e=t.target.getAttribute("data-command");e&&(e=MM.Command[e],e.isValid()&&(e.execute(),this.close()))},init:function(t){this._port=t,this._dom.node=document.querySelector("#menu");var e=this._dom.node.querySelectorAll("[data-command]");[].slice.call(e).forEach(function(t){t.innerHTML=MM.Command[t.getAttribute("data-command")].label}),this._port.addEventListener("mousedown",this),this._dom.node.addEventListener("mousedown",this),this.close()}},MM.Command=Object.create(MM.Repo,{keys:{value:[]},editMode:{value:!1},prevent:{value:!0},label:{value:""}}),MM.Command.isValid=function(){return null===this.editMode||this.editMode==MM.App.editing},MM.Command.execute=function(){},MM.Command.Undo=Object.create(MM.Command,{label:{value:"Undo"},keys:{value:[{keyCode:"Z".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.Undo.isValid=function(){return MM.Command.isValid.call(this)&&!!MM.App.historyIndex},MM.Command.Undo.execute=function(){MM.App.history[MM.App.historyIndex-1].undo(),MM.App.historyIndex--},MM.Command.Redo=Object.create(MM.Command,{label:{value:"Redo"},keys:{value:[{keyCode:"Y".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.Redo.isValid=function(){return MM.Command.isValid.call(this)&&MM.App.historyIndex!=MM.App.history.length},MM.Command.Redo.execute=function(){MM.App.history[MM.App.historyIndex].perform(),MM.App.historyIndex++},MM.Command.InsertSibling=Object.create(MM.Command,{label:{value:"Insert a sibling"},keys:{value:[{keyCode:13}]}}),MM.Command.InsertSibling.execute=function(){var t=MM.App.current;if(t.isRoot())var e=new MM.Action.InsertNewItem(t,t.getChildren().length);else var i=t.getParent(),n=i.getChildren().indexOf(t),e=new MM.Action.InsertNewItem(i,n+1);MM.App.action(e),MM.Command.Edit.execute(),MM.publish("command-sibling")},MM.Command.InsertChild=Object.create(MM.Command,{label:{value:"Insert a child"},keys:{value:[{keyCode:9,ctrlKey:!1},{keyCode:45}]}}),MM.Command.InsertChild.execute=function(){var t=MM.App.current,e=new MM.Action.InsertNewItem(t,t.getChildren().length);MM.App.action(e),MM.Command.Edit.execute(),MM.publish("command-child")},MM.Command.Delete=Object.create(MM.Command,{label:{value:"Delete an item"},keys:{value:[{keyCode:46}]}}),MM.Command.Delete.isValid=function(){return MM.Command.isValid.call(this)&&!MM.App.current.isRoot()},MM.Command.Delete.execute=function(){var t=new MM.Action.RemoveItem(MM.App.current);MM.App.action(t)},MM.Command.Swap=Object.create(MM.Command,{label:{value:"Swap sibling"},keys:{value:[{keyCode:38,ctrlKey:!0},{keyCode:40,ctrlKey:!0}]}}),MM.Command.Swap.execute=function(t){var e=MM.App.current;if(!(e.isRoot()||e.getParent().getChildren().length<2)){var i=38==t.keyCode?-1:1,n=new MM.Action.Swap(MM.App.current,i);MM.App.action(n)}},MM.Command.Side=Object.create(MM.Command,{label:{value:"Change side"},keys:{value:[{keyCode:37,ctrlKey:!0},{keyCode:39,ctrlKey:!0}]}}),MM.Command.Side.execute=function(t){var e=MM.App.current;if(!e.isRoot()&&e.getParent().isRoot()){var i=37==t.keyCode?"left":"right",n=new MM.Action.SetSide(MM.App.current,i);MM.App.action(n)}},MM.Command.Save=Object.create(MM.Command,{label:{value:"Save map"},keys:{value:[{keyCode:"S".charCodeAt(0),ctrlKey:!0,shiftKey:!1}]}}),MM.Command.Save.execute=function(){MM.App.io.quickSave()},MM.Command.SaveAs=Object.create(MM.Command,{label:{value:"Save as&hellip;"},keys:{value:[{keyCode:"S".charCodeAt(0),ctrlKey:!0,shiftKey:!0}]}}),MM.Command.SaveAs.execute=function(){MM.App.io.show("save")},MM.Command.Load=Object.create(MM.Command,{label:{value:"Load map"},keys:{value:[{keyCode:"O".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.Load.execute=function(){MM.App.io.show("load")},MM.Command.Center=Object.create(MM.Command,{label:{value:"Center map"},keys:{value:[{keyCode:35}]}}),MM.Command.Center.execute=function(){MM.App.map.center()},MM.Command.New=Object.create(MM.Command,{label:{value:"New map"},keys:{value:[{keyCode:"N".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.New.execute=function(){if(confirm("Throw away your current map and start a new one?")){var t=new MM.Map;MM.App.setMap(t),MM.publish("map-new",this)}},MM.Command.ZoomIn=Object.create(MM.Command,{label:{value:"Zoom in"},keys:{value:[{charCode:"+".charCodeAt(0)}]}}),MM.Command.ZoomIn.execute=function(){MM.App.adjustFontSize(1)},MM.Command.ZoomOut=Object.create(MM.Command,{label:{value:"Zoom out"},keys:{value:[{charCode:"-".charCodeAt(0)}]}}),MM.Command.ZoomOut.execute=function(){MM.App.adjustFontSize(-1)},MM.Command.Help=Object.create(MM.Command,{label:{value:"Show/hide help"},keys:{value:[{charCode:"?".charCodeAt(0)}]}}),MM.Command.Help.execute=function(){MM.App.help.toggle()},MM.Command.UI=Object.create(MM.Command,{label:{value:"Show/hide UI"},keys:{value:[{charCode:"*".charCodeAt(0)}]}}),MM.Command.UI.execute=function(){MM.App.ui.toggle()},MM.Command.Pan=Object.create(MM.Command,{label:{value:"Pan the map"},keys:{value:[{keyCode:"W".charCodeAt(0),ctrlKey:!1,altKey:!1,metaKey:!1},{keyCode:"A".charCodeAt(0),ctrlKey:!1,altKey:!1,metaKey:!1},{keyCode:"S".charCodeAt(0),ctrlKey:!1,altKey:!1,metaKey:!1},{keyCode:"D".charCodeAt(0),ctrlKey:!1,altKey:!1,metaKey:!1}]},chars:{value:[]}}),MM.Command.Pan.execute=function(t){var e=String.fromCharCode(t.keyCode),i=this.chars.indexOf(e);i>-1||(this.chars.length||(window.addEventListener("keyup",this),this.interval=setInterval(this._step.bind(this),50)),this.chars.push(e),this._step())},MM.Command.Pan._step=function(){var t={W:[0,1],A:[1,0],S:[0,-1],D:[-1,0]},e=[0,0];this.chars.forEach(function(i){e[0]+=t[i][0],e[1]+=t[i][1]}),MM.App.map.moveBy(15*e[0],15*e[1])},MM.Command.Pan.handleEvent=function(t){
var e=String.fromCharCode(t.keyCode),i=this.chars.indexOf(e);i>-1&&(this.chars.splice(i,1),this.chars.length||(window.removeEventListener("keyup",this),clearInterval(this.interval)))};MM.Command.Copy=Object.create(MM.Command,{label:{value:"Copy"},prevent:{value:!1},keys:{value:[{keyCode:"C".charCodeAt(0),ctrlKey:!0},{keyCode:"C".charCodeAt(0),metaKey:!0}]}});MM.Command.Copy.execute=function(){MM.Clipboard.copy(MM.App.current)},MM.Command.Cut=Object.create(MM.Command,{label:{value:"Cut"},prevent:{value:!1},keys:{value:[{keyCode:"X".charCodeAt(0),ctrlKey:!0},{keyCode:"X".charCodeAt(0),metaKey:!0}]}}),MM.Command.Cut.execute=function(){MM.Clipboard.cut(MM.App.current)},MM.Command.Paste=Object.create(MM.Command,{label:{value:"Paste"},prevent:{value:!1},keys:{value:[{keyCode:"V".charCodeAt(0),ctrlKey:!0},{keyCode:"V".charCodeAt(0),metaKey:!0}]}}),MM.Command.Paste.execute=function(){MM.Clipboard.paste(MM.App.current)},MM.Command.Fold=Object.create(MM.Command,{label:{value:"Fold/Unfold"},keys:{value:[{charCode:"f".charCodeAt(0),ctrlKey:!1}]}}),MM.Command.Fold.execute=function(){var t=MM.App.current;t.isCollapsed()?t.expand():t.collapse(),MM.App.map.ensureItemVisibility(t)},MM.Command.Edit=Object.create(MM.Command,{label:{value:"Edit item"},keys:{value:[{keyCode:32},{keyCode:113}]}}),MM.Command.Edit.execute=function(){MM.App.current.startEditing(),MM.App.editing=!0},MM.Command.Finish=Object.create(MM.Command,{keys:{value:[{keyCode:13,altKey:!1,ctrlKey:!1,shiftKey:!1}]},editMode:{value:!0}}),MM.Command.Finish.execute=function(){MM.App.editing=!1;var t=MM.App.current.stopEditing();if(t)var e=new MM.Action.SetText(MM.App.current,t);else var e=new MM.Action.RemoveItem(MM.App.current);MM.App.action(e)},MM.Command.Newline=Object.create(MM.Command,{label:{value:"Line break"},keys:{value:[{keyCode:13,shiftKey:!0},{keyCode:13,ctrlKey:!0}]},editMode:{value:!0}}),MM.Command.Newline.execute=function(){var t=getSelection().getRangeAt(0),e=document.createElement("br");t.insertNode(e),t.setStartAfter(e),MM.App.current.updateSubtree()},MM.Command.Cancel=Object.create(MM.Command,{editMode:{value:!0},keys:{value:[{keyCode:27}]}}),MM.Command.Cancel.execute=function(){MM.App.editing=!1,MM.App.current.stopEditing();var t=MM.App.current.getText();if(!t){var e=new MM.Action.RemoveItem(MM.App.current);MM.App.action(e)}},MM.Command.Style=Object.create(MM.Command,{editMode:{value:null},command:{value:""}}),MM.Command.Style.execute=function(){if(MM.App.editing)document.execCommand(this.command,null,null);else{MM.Command.Edit.execute();var t=getSelection(),e=t.getRangeAt(0);e.selectNodeContents(MM.App.current.getDOM().text),t.removeAllRanges(),t.addRange(e),this.execute(),MM.Command.Finish.execute()}},MM.Command.Bold=Object.create(MM.Command.Style,{command:{value:"bold"},label:{value:"Bold"},keys:{value:[{keyCode:"B".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.Underline=Object.create(MM.Command.Style,{command:{value:"underline"},label:{value:"Underline"},keys:{value:[{keyCode:"U".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.Italic=Object.create(MM.Command.Style,{command:{value:"italic"},label:{value:"Italic"},keys:{value:[{keyCode:"I".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.Strikethrough=Object.create(MM.Command.Style,{command:{value:"strikeThrough"},label:{value:"Strike-through"},keys:{value:[{keyCode:"S".charCodeAt(0),ctrlKey:!0}]}}),MM.Command.Value=Object.create(MM.Command,{label:{value:"Set value"},keys:{value:[{charCode:"v".charCodeAt(0),ctrlKey:!1,metaKey:!1}]}}),MM.Command.Value.execute=function(){var t=MM.App.current,e=t.getValue(),i=prompt("Set item value",e);if(null!=i){i.length||(i=null);var n=parseFloat(i),o=new MM.Action.SetValue(t,isNaN(n)?i:n);MM.App.action(o)}},MM.Command.Yes=Object.create(MM.Command,{label:{value:"Yes"},keys:{value:[{charCode:"y".charCodeAt(0),ctrlKey:!1}]}}),MM.Command.Yes.execute=function(){var t=MM.App.current,e="yes"==t.getStatus()?null:"yes",i=new MM.Action.SetStatus(t,e);MM.App.action(i)},MM.Command.No=Object.create(MM.Command,{label:{value:"No"},keys:{value:[{charCode:"n".charCodeAt(0),ctrlKey:!1}]}}),MM.Command.No.execute=function(){var t=MM.App.current,e="no"==t.getStatus()?null:"no",i=new MM.Action.SetStatus(t,e);MM.App.action(i)},MM.Command.Computed=Object.create(MM.Command,{label:{value:"Computed"},keys:{value:[{charCode:"c".charCodeAt(0),ctrlKey:!1,metaKey:!1}]}}),MM.Command.Computed.execute=function(){var t=MM.App.current,e="computed"==t.getStatus()?null:"computed",i=new MM.Action.SetStatus(t,e);MM.App.action(i)},MM.Command.Select=Object.create(MM.Command,{label:{value:"Move selection"},keys:{value:[{keyCode:38,ctrlKey:!1},{keyCode:37,ctrlKey:!1},{keyCode:40,ctrlKey:!1},{keyCode:39,ctrlKey:!1}]}}),MM.Command.Select.execute=function(t){var e={37:"left",38:"top",39:"right",40:"bottom"},i=e[t.keyCode],n=MM.App.current.getLayout(),o=n.pick(MM.App.current,i);MM.App.select(o)},MM.Command.SelectRoot=Object.create(MM.Command,{label:{value:"Select root"},keys:{value:[{keyCode:36}]}}),MM.Command.SelectRoot.execute=function(){for(var t=MM.App.current;!t.isRoot();)t=t.getParent();MM.App.select(t)},MM.Command.SelectParent=Object.create(MM.Command,{label:{value:"Select parent"},keys:{value:[{keyCode:8}]}}),MM.Command.SelectParent.execute=function(){MM.App.current.isRoot()||MM.App.select(MM.App.current.getParent())},MM.Layout=Object.create(MM.Repo,{ALL:{value:[]},SPACING_RANK:{value:4},SPACING_CHILD:{value:4}}),MM.Layout.getAll=function(){return this.ALL},MM.Layout.update=function(t){return this},MM.Layout.getChildDirection=function(t){return""},MM.Layout.pick=function(t,e){var i={left:"right",right:"left",top:"bottom",bottom:"top"};if(!t.isCollapsed())for(var n=t.getChildren(),o=0;o<n.length;o++){var a=n[o];if(this.getChildDirection(a)==e)return a}if(t.isRoot())return t;var r=t.getParent().getLayout(),s=r.getChildDirection(t);return s==e?t:s==i[e]?t.getParent():r.pickSibling(t,"left"==e||"top"==e?-1:1)},MM.Layout.pickSibling=function(t,e){if(t.isRoot())return t;var i=t.getParent().getChildren(),n=i.indexOf(t);return n+=e,n=(n+i.length)%i.length,i[n]},MM.Layout._anchorCanvas=function(t){var e=t.getDOM();e.canvas.width=e.node.offsetWidth,e.canvas.height=e.node.offsetHeight},MM.Layout._anchorToggle=function(t,e,i,n){var o=t.getDOM().toggle,a=o.offsetWidth,r=o.offsetHeight,s=e,h=i;switch(n){case"left":h-=r/2,s-=a;break;case"right":h-=r/2;break;case"top":s-=a/2,h-=r;break;case"bottom":s-=a/2}o.style.left=Math.round(s)+"px",o.style.top=Math.round(h)+"px"},MM.Layout._getChildAnchor=function(t,e){var i=t.getDOM();if("left"==e||"right"==e){var n=i.node.offsetLeft+i.content.offsetLeft;"left"==e&&(n+=i.content.offsetWidth)}else{var n=i.node.offsetTop+i.content.offsetTop;"top"==e&&(n+=i.content.offsetHeight)}return n},MM.Layout._computeChildrenBBox=function(t,e){var i=[0,0],n=(e+1)%2;return t.forEach(function(t,o){var a=t.getDOM().node,r=[a.offsetWidth,a.offsetHeight];i[n]=Math.max(i[n],r[n]),i[e]+=r[e]},this),t.length>1&&(i[e]+=this.SPACING_CHILD*(t.length-1)),i},MM.Layout._alignItem=function(t,e){var i=t.getDOM();switch(e){case"left":i.content.appendChild(i.value),i.content.appendChild(i.status);break;case"right":i.content.insertBefore(i.value,i.content.firstChild),i.content.insertBefore(i.status,i.content.firstChild)}},MM.Layout.Graph=Object.create(MM.Layout,{SPACING_RANK:{value:16},childDirection:{value:""}}),MM.Layout.Graph.getChildDirection=function(t){return this.childDirection},MM.Layout.Graph.create=function(t,e,i){var n=Object.create(this,{childDirection:{value:t},id:{value:e},label:{value:i}});return MM.Layout.ALL.push(n),n},MM.Layout.Graph.update=function(t){var e=this.childDirection;return t.isRoot()||(e=t.getParent().getLayout().getChildDirection(t)),this._alignItem(t,e),this._layoutItem(t,this.childDirection),"left"==this.childDirection||"right"==this.childDirection?this._drawLinesHorizontal(t,this.childDirection):this._drawLinesVertical(t,this.childDirection),this},MM.Layout.Graph._layoutItem=function(t,e){var i=["width","height"],n=["left","top"],o="left"==e||"right"==e?0:1,a=(o+1)%2,r=n[o],s=n[a],h=i[o],l=i[a],c=t.getDOM(),d=[c.content.offsetWidth,c.content.offsetHeight],u=this._computeChildrenBBox(t.getChildren(),a),M=d[o];u[o]&&(M+=u[o]+this.SPACING_RANK);var p=Math.max(u[a],d[a]);c.node.style[h]=M+"px",c.node.style[l]=p+"px";var m=[0,0];"right"==e&&(m[0]=d[0]+this.SPACING_RANK),"bottom"==e&&(m[1]=d[1]+this.SPACING_RANK),m[a]=Math.round((p-u[a])/2),this._layoutChildren(t.getChildren(),e,m,u);var f=0;return"left"==e&&(f=M-d[0]),"top"==e&&(f=M-d[1]),c.content.style[s]=Math.round((p-d[a])/2)+"px",c.content.style[r]=f+"px",this},MM.Layout.Graph._layoutChildren=function(t,e,i,n){var o=["left","top"],a="left"==e||"right"==e?0:1,r=(a+1)%2,s=o[a],h=o[r];return t.forEach(function(t,o){var l=t.getDOM().node,c=[l.offsetWidth,l.offsetHeight];"left"==e&&(i[0]=n[0]-c[0]),"top"==e&&(i[1]=n[1]-c[1]),l.style[h]=i[r]+"px",l.style[s]=i[a]+"px",i[r]+=c[r]+this.SPACING_CHILD},this),n},MM.Layout.Graph._drawLinesHorizontal=function(t,e){this._anchorCanvas(t),this._drawHorizontalConnectors(t,e,t.getChildren())},MM.Layout.Graph._drawLinesVertical=function(t,e){this._anchorCanvas(t),this._drawVerticalConnectors(t,e,t.getChildren())},MM.Layout.Graph._drawHorizontalConnectors=function(t,e,i){if(0!=i.length){var n=t.getDOM(),o=n.canvas,a=o.getContext("2d");a.strokeStyle=t.getColor();var r=this.SPACING_RANK/2,s=t.getShape().getVerticalAnchor(t);if("left"==e)var h=n.content.offsetLeft-.5;else var h=n.content.offsetWidth+n.content.offsetLeft+.5;if(this._anchorToggle(t,h,s,e),!t.isCollapsed()){if(1==i.length){var l=i[0],c=l.getShape().getVerticalAnchor(l)+l.getDOM().node.offsetTop,d=this._getChildAnchor(l,e);return a.beginPath(),a.moveTo(h,s),a.bezierCurveTo((h+d)/2,s,(h+d)/2,c,d,c),void a.stroke()}if("left"==e)var d=h-r;else var d=h+r;a.beginPath(),a.moveTo(h,s),a.lineTo(d,s),a.stroke();var u=i[0],M=i[i.length-1],p=d,m=p+("left"==e?-r:r),s=u.getShape().getVerticalAnchor(u)+u.getDOM().node.offsetTop,c=M.getShape().getVerticalAnchor(M)+M.getDOM().node.offsetTop,h=this._getChildAnchor(u,e),d=this._getChildAnchor(M,e);a.beginPath(),a.moveTo(h,s),a.lineTo(m,s),a.arcTo(p,s,p,s+r,r),a.lineTo(p,c-r),a.arcTo(p,c,m,c,r),a.lineTo(d,c);for(var f=1;f<i.length-1;f++){var _=i[f],v=_.getShape().getVerticalAnchor(_)+_.getDOM().node.offsetTop;a.moveTo(p,v),a.lineTo(this._getChildAnchor(_,e),v)}a.stroke()}}},MM.Layout.Graph._drawVerticalConnectors=function(t,e,i){if(0!=i.length){var n=t.getDOM(),o=n.canvas,a=o.getContext("2d");a.strokeStyle=t.getColor();var r=this.SPACING_RANK/2,s=t.getShape().getHorizontalAnchor(t),h=1==i.length?2*r:r;if("top"==e){var l=o.height-n.content.offsetHeight,c=l-h;this._anchorToggle(t,s,l,e)}else{var l=t.getShape().getVerticalAnchor(t),c=n.content.offsetHeight+h;this._anchorToggle(t,s,n.content.offsetHeight,e)}if(a.beginPath(),a.moveTo(s,l),a.lineTo(s,c),a.stroke(),1!=i.length){var d=i[0],u=i[i.length-1],M=n.content.offsetHeight+h,p=Math.round("top"==e?o.height-M:M)+.5,m=d.getShape().getHorizontalAnchor(d)+d.getDOM().node.offsetLeft,f=u.getShape().getHorizontalAnchor(u)+u.getDOM().node.offsetLeft,l=this._getChildAnchor(d,e),c=this._getChildAnchor(u,e);a.beginPath(),a.moveTo(m,l),a.arcTo(m,p,m+r,p,r),a.lineTo(f-r,p),a.arcTo(f,p,f,c,r);for(var _=1;_<i.length-1;_++){var v=i[_],s=v.getShape().getHorizontalAnchor(v)+v.getDOM().node.offsetLeft;a.moveTo(s,p),a.lineTo(s,this._getChildAnchor(v,e))}a.stroke()}}},MM.Layout.Graph.Down=MM.Layout.Graph.create("bottom","graph-bottom","Bottom"),MM.Layout.Graph.Up=MM.Layout.Graph.create("top","graph-top","Top"),MM.Layout.Graph.Left=MM.Layout.Graph.create("left","graph-left","Left"),MM.Layout.Graph.Right=MM.Layout.Graph.create("right","graph-right","Right"),MM.Layout.Tree=Object.create(MM.Layout,{SPACING_RANK:{value:32},childDirection:{value:""}}),MM.Layout.Tree.getChildDirection=function(t){return this.childDirection},MM.Layout.Tree.create=function(t,e,i){var n=Object.create(this,{childDirection:{value:t},id:{value:e},label:{value:i}});return MM.Layout.ALL.push(n),n},MM.Layout.Tree.update=function(t){var e=this.childDirection;return t.isRoot()||(e=t.getParent().getLayout().getChildDirection(t)),this._alignItem(t,e),this._layoutItem(t,this.childDirection),this._anchorCanvas(t),this._drawLines(t,this.childDirection),this},MM.Layout.Tree._layoutItem=function(t,e){var i=t.getDOM(),n=[i.content.offsetWidth,i.content.offsetHeight],o=this._computeChildrenBBox(t.getChildren(),1),a=n[0],r=o[1]+n[1];o[0]&&(a=Math.max(a,o[0]+this.SPACING_RANK),r+=this.SPACING_CHILD),i.node.style.width=a+"px",i.node.style.height=r+"px";var s=[this.SPACING_RANK,n[1]+this.SPACING_CHILD];"left"==e&&(s[0]=a-o[0]-this.SPACING_RANK),this._layoutChildren(t.getChildren(),e,s,o);var h=0;return"left"==e&&(h=a-n[0]),i.content.style.left=h+"px",i.content.style.top=0,this},MM.Layout.Tree._layoutChildren=function(t,e,i,n){return t.forEach(function(t,o){var a=t.getDOM().node,r=[a.offsetWidth,a.offsetHeight],s=i[0];"left"==e&&(s+=n[0]-r[0]),a.style.left=s+"px",a.style.top=i[1]+"px",i[1]+=r[1]+this.SPACING_CHILD},this),n},MM.Layout.Tree._drawLines=function(t,e){var i=t.getDOM(),n=i.canvas,o=this.SPACING_RANK/4,a=("left"==e?n.width-2*o:2*o)+.5;this._anchorToggle(t,a,i.content.offsetHeight,"bottom");var r=t.getChildren();if(0!=r.length&&!t.isCollapsed()){var s=n.getContext("2d");s.strokeStyle=t.getColor();var h=t.getShape().getVerticalAnchor(t),l=r[r.length-1],c=l.getShape().getVerticalAnchor(l)+l.getDOM().node.offsetTop;s.beginPath(),s.moveTo(a,h),s.lineTo(a,c-o);for(var d=0;d<r.length;d++){var u=r[d],M=u.getShape().getVerticalAnchor(u)+u.getDOM().node.offsetTop,p=this._getChildAnchor(u,e);s.moveTo(a,M-o),s.arcTo(a,M,p,M,o),s.lineTo(p,M)}s.stroke()}},MM.Layout.Tree.Left=MM.Layout.Tree.create("left","tree-left","Left"),MM.Layout.Tree.Right=MM.Layout.Tree.create("right","tree-right","Right"),MM.Layout.Map=Object.create(MM.Layout.Graph,{id:{value:"map"},label:{value:"Map"},LINE_THICKNESS:{value:8}}),MM.Layout.ALL.push(MM.Layout.Map),MM.Layout.Map.update=function(t){if(t.isRoot())this._layoutRoot(t);else{var e=this.getChildDirection(t),i=e.charAt(0).toUpperCase()+e.substring(1);MM.Layout.Graph[i].update(t)}},MM.Layout.Map.getChildDirection=function(t){for(;!t.getParent().isRoot();)t=t.getParent();var e=t.getSide();if(e)return e;for(var i={left:0,right:0},n=t.getParent().getChildren(),o=0;o<n.length;o++){var e=n[o].getSide();e||(e=i.right>i.left?"left":"right",n[o].setSide(e)),i[e]++}return t.getSide()},MM.Layout.Map.pickSibling=function(t,e){if(t.isRoot())return t;var i=t.getParent(),n=i.getChildren();if(i.isRoot()){var o=this.getChildDirection(t);n=n.filter(function(t){return this.getChildDirection(t)==o},this)}var a=n.indexOf(t);return a+=e,a=(a+n.length)%n.length,n[a]},MM.Layout.Map._layoutRoot=function(t){this._alignItem(t,"right");var e=t.getDOM(),i=t.getChildren(),n=[],o=[];i.forEach(function(t,e){var i=(t.getDOM().node,this.getChildDirection(t));"left"==i?n.push(t):o.push(t)},this);var a=this._computeChildrenBBox(n,1),r=this._computeChildrenBBox(o,1),s=Math.max(a[1],r[1],e.content.offsetHeight),h=0;this._layoutChildren(n,"left",[h,Math.round((s-a[1])/2)],a),h+=a[0],n.length&&(h+=this.SPACING_RANK),e.content.style.left=h+"px",h+=e.content.offsetWidth,o.length&&(h+=this.SPACING_RANK),this._layoutChildren(o,"right",[h,Math.round((s-r[1])/2)],r),h+=r[0],e.content.style.top=Math.round((s-e.content.offsetHeight)/2)+"px",e.node.style.height=s+"px",e.node.style.width=h+"px",this._anchorCanvas(t),this._drawRootConnectors(t,"left",n),this._drawRootConnectors(t,"right",o)},MM.Layout.Map._drawRootConnectors=function(t,e,i){if(0!=i.length&&!t.isCollapsed())for(var n=t.getDOM(),o=n.canvas,a=o.getContext("2d"),r=(this.SPACING_RANK/2,n.content.offsetLeft+n.content.offsetWidth/2),s=t.getShape().getVerticalAnchor(t),h=this.LINE_THICKNESS/2,l=0;l<i.length;l++){var c=i[l],d=this._getChildAnchor(c,e),u=c.getShape().getVerticalAnchor(c)+c.getDOM().node.offsetTop,M=Math.atan2(u-s,d-r)+Math.PI/2,p=Math.cos(M)*h,m=Math.sin(M)*h;a.fillStyle=a.strokeStyle=c.getColor(),a.beginPath(),a.moveTo(r-p,s-m),a.quadraticCurveTo((d+r)/2,u,d,u),a.quadraticCurveTo((d+r)/2,u,r+p,s+m),a.fill(),a.stroke()}},MM.Shape=Object.create(MM.Repo,{VERTICAL_OFFSET:{value:.5}}),MM.Shape.set=function(t){return t.getDOM().node.classList.add("shape-"+this.id),this},MM.Shape.unset=function(t){return t.getDOM().node.classList.remove("shape-"+this.id),this},MM.Shape.update=function(t){return t.getDOM().content.style.borderColor=t.getColor(),this},MM.Shape.getHorizontalAnchor=function(t){var e=t.getDOM().content;return Math.round(e.offsetLeft+e.offsetWidth/2)+.5},MM.Shape.getVerticalAnchor=function(t){var e=t.getDOM().content;return e.offsetTop+Math.round(e.offsetHeight*this.VERTICAL_OFFSET)+.5},MM.Shape.Underline=Object.create(MM.Shape,{id:{value:"underline"},label:{value:"Underline"},VERTICAL_OFFSET:{value:-3}}),MM.Shape.Underline.update=function(t){var e=t.getDOM(),i=e.canvas.getContext("2d");i.strokeStyle=t.getColor();var n=e.content.offsetLeft,o=n+e.content.offsetWidth,a=this.getVerticalAnchor(t);i.beginPath(),i.moveTo(n,a),i.lineTo(o,a),i.stroke()},MM.Shape.Underline.getVerticalAnchor=function(t){var e=t.getDOM().content;return e.offsetTop+e.offsetHeight+this.VERTICAL_OFFSET+.5},MM.Shape.Box=Object.create(MM.Shape,{id:{value:"box"},label:{value:"Box"}}),MM.Shape.Ellipse=Object.create(MM.Shape,{id:{value:"ellipse"},label:{value:"Ellipse"}}),MM.Format=Object.create(MM.Repo,{extension:{value:""},mime:{value:""}}),MM.Format.getByName=function(t){var e=t.lastIndexOf(".");if(e==-1)return null;var i=t.substring(e+1).toLowerCase();return this.getByProperty("extension",i)},MM.Format.getByMime=function(t){return this.getByProperty("mime",t)},MM.Format.to=function(t){},MM.Format.from=function(t){},MM.Format.nl2br=function(t){return t.replace(/\n/g,"<br/>")},MM.Format.br2nl=function(t){return t.replace(/<br\s*\/?>/g,"\n")},MM.Format.JSON=Object.create(MM.Format,{id:{value:"json"},label:{value:"Native (JSON)"},extension:{value:"mymind"},mime:{value:"application/vnd.mymind+json"}}),MM.Format.JSON.to=function(t){return JSON.stringify(t,null,"\t")+"\n"},MM.Format.JSON.from=function(t){return JSON.parse(t)},MM.Format.FreeMind=Object.create(MM.Format,{id:{value:"freemind"},label:{value:"FreeMind"},extension:{value:"mm"},mime:{value:"application/x-freemind"}}),MM.Format.FreeMind.to=function(t){var e=document.implementation.createDocument("","",null),i=e.createElement("map");i.setAttribute("version","0.9.0"),i.appendChild(this._serializeItem(e,t.root)),e.appendChild(i);var n=new XMLSerializer;return n.serializeToString(e)},MM.Format.FreeMind.from=function(t){var e=new DOMParser,i=e.parseFromString(t,"application/xml");if("parsererror"==i.documentElement.nodeName.toLowerCase())throw new Error(i.documentElement.textContent);var n=i.documentElement.getElementsByTagName("node")[0];if(!n)throw new Error("No root node found");var o={root:this._parseNode(n,{shape:"underline"})};return o.root.layout="map",o.root.shape="ellipse",o},MM.Format.FreeMind._serializeItem=function(t,e){var i=this._serializeAttributes(t,e);return(e.children||[]).forEach(function(e){i.appendChild(this._serializeItem(t,e))},this),i},MM.Format.FreeMind._serializeAttributes=function(t,e){var i=t.createElement("node");return i.setAttribute("TEXT",MM.Format.br2nl(e.text)),i.setAttribute("ID",e.id),e.side&&i.setAttribute("POSITION",e.side),"box"==e.shape&&i.setAttribute("STYLE","bubble"),e.collapsed&&i.setAttribute("FOLDED","true"),i},MM.Format.FreeMind._parseNode=function(t,e){for(var i=this._parseAttributes(t,e),n=0;n<t.childNodes.length;n++){var o=t.childNodes[n];"node"==o.nodeName.toLowerCase()&&i.children.push(this._parseNode(o,i))}return i},MM.Format.FreeMind._parseAttributes=function(t,e){var i={children:[],text:MM.Format.nl2br(t.getAttribute("TEXT")||""),id:t.getAttribute("ID")},n=t.getAttribute("POSITION");n&&(i.side=n);var o=t.getAttribute("STYLE");"bubble"==o?i.shape="box":i.shape=e.shape,"true"==t.getAttribute("FOLDED")&&(i.collapsed=1);for(var a=t.children,r=0;r<a.length;r++){var s=a[r];switch(s.nodeName.toLowerCase()){case"richcontent":var h=s.querySelector("body > *");if(h){var l=new XMLSerializer;i.text=l.serializeToString(h).trim()}break;case"font":"true"==s.getAttribute("ITALIC")&&(i.text="<i>"+i.text+"</i>"),"true"==s.getAttribute("BOLD")&&(i.text="<b>"+i.text+"</b>")}}return i},MM.Format.MMA=Object.create(MM.Format.FreeMind,{id:{value:"mma"},label:{value:"Mind Map Architect"},extension:{value:"mma"}}),MM.Format.MMA._parseAttributes=function(t,e){var i={children:[],text:MM.Format.nl2br(t.getAttribute("title")||""),shape:"box"};"false"==t.getAttribute("expand")&&(i.collapsed=1);var n=t.getAttribute("direction");"0"==n&&(i.side="left"),"1"==n&&(i.side="right");var o=t.getAttribute("color");if(o){var a=o.match(/^#(....)(....)(....)$/);if(a){var r=parseInt(a[1],16)>>8,s=parseInt(a[2],16)>>8,h=parseInt(a[3],16)>>8;r=Math.round(r/17).toString(16),s=Math.round(s/17).toString(16),h=Math.round(h/17).toString(16)}i.color="#"+[r,s,h].join("")}return i},MM.Format.MMA._serializeAttributes=function(t,e){var i=t.createElement("node");if(i.setAttribute("title",MM.Format.br2nl(e.text)),i.setAttribute("expand",e.collapsed?"false":"true"),e.side&&i.setAttribute("direction","left"==e.side?"0":"1"),e.color){var n=e.color.match(/^#(.)(.)(.)$/),o=new Array(5).join(n[1]),a=new Array(5).join(n[2]),r=new Array(5).join(n[3]);i.setAttribute("color","#"+[o,a,r].join(""))}return i},MM.Format.Mup=Object.create(MM.Format,{id:{value:"mup"},label:{value:"MindMup"},extension:{value:"mup"}}),MM.Format.Mup.to=function(t){var e=this._MMtoMup(t.root);return JSON.stringify(e,null,2)},MM.Format.Mup.from=function(t){var e=JSON.parse(t),i=this._MupToMM(e);i.layout="map";var n={root:i};return n},MM.Format.Mup._MupToMM=function(t){var e={text:MM.Format.nl2br(t.title),id:t.id,shape:"box"};if(t.attr&&t.attr.style&&t.attr.style.background&&(e.color=t.attr.style.background),t.attr&&t.attr.collapsed&&(e.collapsed=1),t.ideas){var i=[];for(var n in t.ideas){var o=this._MupToMM(t.ideas[n]),a=parseFloat(n);o.side=a<0?"left":"right",i.push({child:o,num:a})}i.sort(function(t,e){return t.num-e.num}),e.children=i.map(function(t){return t.child})}return e},MM.Format.Mup._MMtoMup=function(t,e){var i={id:t.id,title:MM.Format.br2nl(t.text),attr:{}};if(t.color&&(i.attr.style={background:t.color}),t.collapsed&&(i.attr.collapsed=!0),t.children){i.ideas={};for(var n=0;n<t.children.length;n++){var o=t.children[n],a=e||o.side,r=n+1;"left"==a&&(r*=-1),i.ideas[r]=this._MMtoMup(o,a)}}return i},MM.Format.Plaintext=Object.create(MM.Format,{id:{value:"plaintext"},label:{value:"Plain text"},extension:{value:"txt"},mime:{value:"application/vnd.mymind+txt"}}),MM.Format.Plaintext.to=function(t){return this._serializeItem(t.root||t)},MM.Format.Plaintext.from=function(t){var e=t.split("\n").filter(function(t){return t.match(/\S/)}),i=this._parseItems(e);if(1==i.length)var n={root:i[0]};else var n={root:{text:"",children:i}};return n.root.layout="map",n},MM.Format.Plaintext._serializeItem=function(t,e){e=e||0;var i=(t.children||[]).map(function(t){return this._serializeItem(t,e+1)},this),n=new Array(e+1).join("\t");return i.unshift(n+t.text.replace(/\n/g,"")),i.join("\n")+(e?"":"\n")},MM.Format.Plaintext._parseItems=function(t){var e=[];if(!t.length)return e;var i=this._parsePrefix(t[0]),n=null,o=[],a=function(){if(n&&o.length){var t=this._parseItems(o);t.length&&(n.children=t),o=[]}};return t.forEach(function(t,r){this._parsePrefix(t)==i?(a.call(this),n={text:t.match(/^\s*(.*)/)[1]},e.push(n)):o.push(t)},this),a.call(this),e},MM.Format.Plaintext._parsePrefix=function(t){return t.match(/^\s*/)[0]},MM.Backend=Object.create(MM.Repo),MM.Backend.reset=function(){},MM.Backend.save=function(t,e){},MM.Backend.load=function(t){},MM.Backend.Local=Object.create(MM.Backend,{label:{value:"Browser storage"},id:{value:"local"},prefix:{value:"mm.map."}}),MM.Backend.Local.save=function(t,e,i){localStorage.setItem(this.prefix+e,t);var n=this.list();n[e]=i,localStorage.setItem(this.prefix+"names",JSON.stringify(n))},MM.Backend.Local.load=function(t){var e=localStorage.getItem(this.prefix+t);if(!e)throw new Error("There is no such saved map");return e},MM.Backend.Local.remove=function(t){localStorage.removeItem(this.prefix+t);var e=this.list();delete e[t],localStorage.setItem(this.prefix+"names",JSON.stringify(e))},MM.Backend.Local.list=function(){try{var t=localStorage.getItem(this.prefix+"names")||"{}";return JSON.parse(t)}catch(t){return{}}},MM.Backend.WebDAV=Object.create(MM.Backend,{id:{value:"webdav"},label:{value:"Generic WebDAV"}}),MM.Backend.WebDAV.save=function(t,e){return this._request("put",e,t)},MM.Backend.WebDAV.load=function(t){return this._request("get",t)},MM.Backend.WebDAV._request=function(t,e,i){var n=new XMLHttpRequest;n.open(t,e,!0),n.withCredentials=!0;var o=new Promise;return Promise.send(n,i).then(function(t){o.fulfill(t.responseText)},function(t){o.reject(new Error("HTTP/"+t.status+"\n\n"+t.responseText))}),o},MM.Backend.Image=Object.create(MM.Backend,{id:{value:"image"},label:{value:"Image"},url:{value:"",writable:!0}}),MM.Backend.Image.save=function(t,e){var i=document.createElement("form");i.action=this.url,i.method="post",i.target="_blank";var n=document.createElement("input");n.type="hidden",n.name="data",n.value=t,i.appendChild(n);var n=document.createElement("input");n.type="hidden",n.name="name",n.value=e,i.appendChild(n),document.body.appendChild(i),i.submit(),i.parentNode.removeChild(i)},MM.Backend.File=Object.create(MM.Backend,{id:{value:"file"},label:{value:"File"},input:{value:document.createElement("input")}}),MM.Backend.File.save=function(t,e){var i=document.createElement("a");i.download=e,i.href="data:text/plain;base64,"+btoa(unescape(encodeURIComponent(t))),document.body.appendChild(i),i.click(),i.parentNode.removeChild(i);var n=(new Promise).fulfill();return n},MM.Backend.File.load=function(){var t=new Promise;return this.input.type="file",this.input.onchange=function(e){var i=e.target.files[0];if(i){var n=new FileReader;n.onload=function(){t.fulfill({data:n.result,name:i.name})},n.onerror=function(){t.reject(n.error)},n.readAsText(i)}}.bind(this),this.input.click(),t},MM.Backend.Firebase=Object.create(MM.Backend,{label:{value:"Firebase"},id:{value:"firebase"},ref:{value:null,writable:!0},_current:{value:{id:null,name:null,data:null}}}),MM.Backend.Firebase.connect=function(t,e){return this.ref=new Firebase("https://"+t+".firebaseio.com/"),this.ref.child("names").on("value",function(t){MM.publish("firebase-list",this,t.val()||{})},this),e?this._login(e):(new Promise).fulfill()},MM.Backend.Firebase.save=function(t,e,i){var n=new Promise;try{this.ref.child("names/"+e).set(i),this.ref.child("data/"+e).set(t,function(i){i?n.reject(i):(n.fulfill(),this._listenStart(t,e))}.bind(this))}catch(t){n.reject(t)}return n},MM.Backend.Firebase.load=function(t){var e=new Promise;return this.ref.child("data/"+t).once("value",function(i){var n=i.val();n?(e.fulfill(n),this._listenStart(n,t)):e.reject(new Error("There is no such saved map"))},this),e},MM.Backend.Firebase.remove=function(t){var e=new Promise;try{this.ref.child("names/"+t).remove(),this.ref.child("data/"+t).remove(function(t){t?e.reject(t):e.fulfill()})}catch(t){e.reject(t)}return e},MM.Backend.Firebase.reset=function(){this._listenStop()},MM.Backend.Firebase.mergeWith=function(t,e){var i=this._current.id;e!=this._current.name&&(this._current.name=e,this.ref.child("names/"+i).set(e));var n=this.ref.child("data/"+i),o=this._current.data;this._listenStop(),this._recursiveRefMerge(n,o,t),this._listenStart(t,i)},MM.Backend.Firebase._recursiveRefMerge=function(t,e,i){var n={};if(i instanceof Array){for(var o=0;o<i.length;o++){var a=i[o];o in e?"object"==typeof a?this._recursiveRefMerge(t.child(o),e[o],a):a!==e[o]&&(n[o]=a):n[o]=a}for(var o=i.length;o<e.length;o++)n[o]=null}else{for(var r in i){var a=i[r];r in e?"object"==typeof a?this._recursiveRefMerge(t.child(r),e[r],a):a!==e[r]&&(n[r]=a):n[r]=a}for(var r in e)r in i||(n[r]=null)}Object.keys(n).length&&t.update(n)},MM.Backend.Firebase._listenStart=function(t,e){this._current.id&&this._current.id==e||(this._listenStop(),this._current.id=e,this._current.data=t,this.ref.child("data/"+e).on("value",this._valueChange,this))},MM.Backend.Firebase._listenStop=function(){this._current.id&&(this.ref.child("data/"+this._current.id).off("value"),this._current.id=null,this._current.name=null,this._current.data=null)},MM.Backend.Firebase._valueChange=function(t){this._current.data=t.val(),this._changeTimeout&&clearTimeout(this._changeTimeout),this._changeTimeout=setTimeout(function(){MM.publish("firebase-change",this,this._current.data)}.bind(this),200)},MM.Backend.Firebase._login=function(t){var e=new Promise,i=new FirebaseSimpleLogin(this.ref,function(t,i){t?e.reject(t):i&&e.fulfill(i)});return i.login(t),e},MM.Backend.GDrive=Object.create(MM.Backend,{id:{value:"gdrive"},label:{value:"Google Drive"},scope:{value:"https://www.googleapis.com/auth/drive https://www.googleapis.com/auth/drive.install"},clientId:{value:"767837575056-h87qmlhmhb3djhaaqta5gv2v3koa9hii.apps.googleusercontent.com"},apiKey:{value:"AIzaSyCzu1qVxlgufneOYpBgDJXN6Z9SNVcHYWM"},fileId:{value:null,writable:!0}}),MM.Backend.GDrive.reset=function(){this.fileId=null},MM.Backend.GDrive.save=function(t,e,i){return this._connect().then(function(){return this._send(t,e,i)}.bind(this))},MM.Backend.GDrive._send=function(t,e,i){var n=new Promise,o="/upload/drive/v2/files",a="POST";this.fileId&&(o+="/"+this.fileId,a="PUT");var r="b"+Math.random(),s="--"+r,h=[s,"Content-Type: application/json","",JSON.stringify({title:e}),s,"Content-Type: "+i,"",t,s+"--"].join("\r\n"),l=gapi.client.request({path:o,method:a,headers:{"Content-Type":"multipart/mixed; boundary='"+r+"'"},body:h});return l.execute(function(t){t?t.error?n.reject(t.error):(this.fileId=t.id,n.fulfill()):n.reject(new Error("Failed to upload to Google Drive"))}.bind(this)),n},MM.Backend.GDrive.load=function(t){return this._connect().then(this._load.bind(this,t))},MM.Backend.GDrive._load=function(t){this.fileId=t;var e=new Promise,i=gapi.client.request({path:"/drive/v2/files/"+this.fileId,method:"GET"});return i.execute(function(t){if(t&&t.downloadUrl){var i=new XMLHttpRequest;i.open("get",t.downloadUrl,!0),i.setRequestHeader("Authorization","Bearer "+gapi.auth.getToken().access_token),Promise.send(i).then(function(i){e.fulfill({data:i.responseText,name:t.title,mime:t.mimeType})},function(t){e.reject(t.responseText)})}else e.reject(t&&t.error||new Error("Failed to download file"))}.bind(this)),e},MM.Backend.GDrive.pick=function(){return this._connect().then(this._pick.bind(this))},MM.Backend.GDrive._pick=function(){var t=new Promise,e=gapi.auth.getToken(),i=MM.Format.getAll(),n=["application/json; charset=UTF-8","application/json"];i.forEach(function(t){t.mime&&n.unshift(t.mime)});var o=new google.picker.DocsView(google.picker.ViewId.DOCS).setMimeTypes(n.join(",")).setMode(google.picker.DocsViewMode.LIST),a=(new google.picker.PickerBuilder).enableFeature(google.picker.Feature.NAV_HIDDEN).addView(o).setOAuthToken(e.access_token).setDeveloperKey(this.apiKey).setCallback(function(e){switch(e[google.picker.Response.ACTION]){case google.picker.Action.PICKED:var i=e[google.picker.Response.DOCUMENTS][0];t.fulfill(i.id);break;case google.picker.Action.CANCEL:t.fulfill(null)}}).build();return a.setVisible(!0),t},MM.Backend.GDrive._connect=function(){return window.gapi&&window.gapi.auth.getToken()?(new Promise).fulfill():this._loadGapi().then(this._auth.bind(this))},MM.Backend.GDrive._loadGapi=function(){var t=new Promise;if(window.gapi)return t.fulfill();var e=document.createElement("script"),i=("cb"+Math.random()).replace(".","");return window[i]=t.fulfill.bind(t),e.src="https://apis.google.com/js/client:picker.js?onload="+i,document.body.appendChild(e),t},MM.Backend.GDrive._auth=function(t){var e=new Promise;return gapi.auth.authorize({client_id:this.clientId,scope:this.scope,immediate:!t
},function(i){i&&!i.error?e.fulfill():t?e.reject(i&&i.error||new Error("Failed to authorize with Google")):this._auth(!0).then(e.fulfill.bind(e),e.reject.bind(e))}.bind(this)),e},MM.UI=function(){this._node=document.querySelector(".ui"),this._toggle=this._node.querySelector("#toggle"),this._layout=new MM.UI.Layout,this._shape=new MM.UI.Shape,this._color=new MM.UI.Color,this._value=new MM.UI.Value,this._status=new MM.UI.Status,MM.subscribe("item-select",this),MM.subscribe("item-change",this),this._node.addEventListener("click",this),this._node.addEventListener("change",this),this.toggle()},MM.UI.prototype.handleMessage=function(t,e){switch(t){case"item-select":this._update();break;case"item-change":e==MM.App.current&&this._update()}},MM.UI.prototype.handleEvent=function(t){switch(t.type){case"click":if("select"!=t.target.nodeName.toLowerCase()&&MM.Clipboard.focus(),t.target==this._toggle)return void this.toggle();for(var e=t.target;e!=document;){var i=e.getAttribute("data-command");if(i)return void MM.Command[i].execute();e=e.parentNode}break;case"change":MM.Clipboard.focus()}},MM.UI.prototype.toggle=function(){this._node.classList.toggle("visible"),MM.publish("ui-change",this)},MM.UI.prototype.getWidth=function(){return this._node.classList.contains("visible")?this._node.offsetWidth:0},MM.UI.prototype._update=function(){this._layout.update(),this._shape.update(),this._value.update(),this._status.update()},MM.UI.Layout=function(){this._select=document.querySelector("#layout"),this._select.appendChild(MM.Layout.Map.buildOption());var t=this._buildGroup("Graph");t.appendChild(MM.Layout.Graph.Right.buildOption()),t.appendChild(MM.Layout.Graph.Left.buildOption()),t.appendChild(MM.Layout.Graph.Down.buildOption()),t.appendChild(MM.Layout.Graph.Up.buildOption());var t=this._buildGroup("Tree");t.appendChild(MM.Layout.Tree.Right.buildOption()),t.appendChild(MM.Layout.Tree.Left.buildOption()),this._select.addEventListener("change",this)},MM.UI.Layout.prototype.update=function(){var t="",e=MM.App.current.getOwnLayout();e&&(t=e.id),this._select.value=t,this._getOption("").disabled=MM.App.current.isRoot(),this._getOption(MM.Layout.Map.id).disabled=!MM.App.current.isRoot()},MM.UI.Layout.prototype.handleEvent=function(t){var e=MM.Layout.getById(this._select.value),i=new MM.Action.SetLayout(MM.App.current,e);MM.App.action(i)},MM.UI.Layout.prototype._getOption=function(t){return this._select.querySelector("option[value='"+t+"']")},MM.UI.Layout.prototype._buildGroup=function(t){var e=document.createElement("optgroup");return e.label=t,this._select.appendChild(e),e},MM.UI.Shape=function(){this._select=document.querySelector("#shape"),this._select.appendChild(MM.Shape.Box.buildOption()),this._select.appendChild(MM.Shape.Ellipse.buildOption()),this._select.appendChild(MM.Shape.Underline.buildOption()),this._select.addEventListener("change",this)},MM.UI.Shape.prototype.update=function(){var t="",e=MM.App.current.getOwnShape();e&&(t=e.id),this._select.value=t},MM.UI.Shape.prototype.handleEvent=function(t){var e=MM.Shape.getById(this._select.value),i=new MM.Action.SetShape(MM.App.current,e);MM.App.action(i)},MM.UI.Value=function(){this._select=document.querySelector("#value"),this._select.addEventListener("change",this)},MM.UI.Value.prototype.update=function(){var t=MM.App.current.getValue();null===t&&(t=""),"number"==typeof t&&(t="num"),this._select.value=t},MM.UI.Value.prototype.handleEvent=function(t){var e=this._select.value;if("num"==e)MM.Command.Value.execute();else{var i=new MM.Action.SetValue(MM.App.current,e||null);MM.App.action(i)}},MM.UI.Status=function(){this._select=document.querySelector("#status"),this._select.addEventListener("change",this)},MM.UI.Status.prototype.update=function(){this._select.value=MM.App.current.getStatus()||""},MM.UI.Status.prototype.handleEvent=function(t){var e=new MM.Action.SetStatus(MM.App.current,this._select.value||null);MM.App.action(e)},MM.UI.Color=function(){this._node=document.querySelector("#color"),this._node.addEventListener("click",this);for(var t=this._node.querySelectorAll("[data-color]"),e=0;e<t.length;e++){var i=t[e];i.style.backgroundColor=i.getAttribute("data-color")}},MM.UI.Color.prototype.handleEvent=function(t){if(t.preventDefault(),t.target.hasAttribute("data-color")){var e=t.target.getAttribute("data-color")||null,i=new MM.Action.SetColor(MM.App.current,e);MM.App.action(i)}},MM.UI.Help=function(){this._node=document.querySelector("#help"),this._map={8:"Backspace",9:"Tab",13:"↩",32:"Spacebar",33:"PgUp",34:"PgDown",35:"End",36:"Home",37:"←",38:"↑",39:"→",40:"↓",45:"Insert",46:"Delete",65:"A",68:"D",83:"S",87:"W",112:"F1",113:"F2",114:"F3",115:"F4",116:"F5",117:"F6",118:"F7",119:"F8",120:"F9",121:"F10","-":"&minus;"},this._build()},MM.UI.Help.prototype.toggle=function(){this._node.classList.toggle("visible")},MM.UI.Help.prototype._build=function(){var t=this._node.querySelector(".navigation");this._buildRow(t,"Pan"),this._buildRow(t,"Select"),this._buildRow(t,"SelectRoot"),this._buildRow(t,"SelectParent"),this._buildRow(t,"Center"),this._buildRow(t,"ZoomIn","ZoomOut"),this._buildRow(t,"Fold");var t=this._node.querySelector(".manipulation");this._buildRow(t,"InsertSibling"),this._buildRow(t,"InsertChild"),this._buildRow(t,"Swap"),this._buildRow(t,"Side"),this._buildRow(t,"Delete"),this._buildRow(t,"Copy"),this._buildRow(t,"Cut"),this._buildRow(t,"Paste");var t=this._node.querySelector(".editing");this._buildRow(t,"Value"),this._buildRow(t,"Yes","No","Computed"),this._buildRow(t,"Edit"),this._buildRow(t,"Newline"),this._buildRow(t,"Bold"),this._buildRow(t,"Italic"),this._buildRow(t,"Underline"),this._buildRow(t,"Strikethrough");var t=this._node.querySelector(".other");this._buildRow(t,"Undo","Redo"),this._buildRow(t,"Save"),this._buildRow(t,"SaveAs"),this._buildRow(t,"Load"),this._buildRow(t,"Help"),this._buildRow(t,"UI")},MM.UI.Help.prototype._buildRow=function(t,e){for(var i=t.insertRow(-1),n=[],o=[],a=1;a<arguments.length;a++){var r=MM.Command[arguments[a]];n.push(r.label),o=o.concat(r.keys.map(this._formatKey,this))}i.insertCell(-1).innerHTML=n.join("/"),i.insertCell(-1).innerHTML=o.join("/")},MM.UI.Help.prototype._formatKey=function(t){var e="";if(t.ctrlKey&&(e+="Ctrl+"),t.altKey&&(e+="Alt+"),t.shiftKey&&(e+="Shift+"),t.charCode){var i=String.fromCharCode(t.charCode);e+=this._map[i]||i.toUpperCase()}return t.keyCode&&(e+=this._map[t.keyCode]||String.fromCharCode(t.keyCode)),e},MM.UI.IO=function(){this._prefix="mm.app.",this._mode="",this._node=document.querySelector("#io"),this._heading=this._node.querySelector("h3"),this._backend=this._node.querySelector("#backend"),this._currentBackend=null,this._backends={};var t=["local","firebase","gdrive","file","webdav","image"];t.forEach(function(t){var e=MM.UI.Backend.getById(t);e.init(this._backend),this._backends[t]=e},this),this._backend.value=localStorage.getItem(this._prefix+"backend")||MM.Backend.File.id,this._backend.addEventListener("change",this),MM.subscribe("map-new",this),MM.subscribe("save-done",this),MM.subscribe("load-done",this)},MM.UI.IO.prototype.restore=function(){var t={};location.search.substring(1).split("&").forEach(function(e){var i=e.split("=");t[decodeURIComponent(i[0])]=decodeURIComponent(i[1])}),"map"in t&&(t.url=t.map),"url"in t&&!("b"in t)&&(t.b="webdav");var e=MM.UI.Backend.getById(t.b);if(e)return void e.setState(t);if(t.state)try{var i=JSON.parse(t.state);return void("open"==i.action?(i={b:"gdrive",id:i.ids[0]},MM.UI.Backend.GDrive.setState(i)):history.replaceState(null,"","."))}catch(t){}},MM.UI.IO.prototype.handleMessage=function(t,e){switch(t){case"map-new":this._setCurrentBackend(null);break;case"save-done":case"load-done":this.hide(),this._setCurrentBackend(e)}},MM.UI.IO.prototype.show=function(t){this._mode=t,this._node.classList.add("visible"),this._heading.innerHTML=t,this._syncBackend(),window.addEventListener("keydown",this)},MM.UI.IO.prototype.hide=function(){this._node.classList.contains("visible")&&(this._node.classList.remove("visible"),MM.Clipboard.focus(),window.removeEventListener("keydown",this))},MM.UI.IO.prototype.quickSave=function(){this._currentBackend?this._currentBackend.save():this.show("save")},MM.UI.IO.prototype.handleEvent=function(t){switch(t.type){case"keydown":27==t.keyCode&&this.hide();break;case"change":this._syncBackend()}},MM.UI.IO.prototype._syncBackend=function(){var t=this._node.querySelectorAll("div[id]");[].slice.apply(t).forEach(function(t){t.style.display="none"}),this._node.querySelector("#"+this._backend.value).style.display="",this._backends[this._backend.value].show(this._mode)},MM.UI.IO.prototype._setCurrentBackend=function(t){this._currentBackend&&this._currentBackend!=t&&this._currentBackend.reset(),t&&localStorage.setItem(this._prefix+"backend",t.id),this._currentBackend=t;try{this._updateURL()}catch(t){}},MM.UI.IO.prototype._updateURL=function(){var t=this._currentBackend&&this._currentBackend.getState();if(t){var e=Object.keys(t).map(function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])});history.replaceState(null,"","?"+e.join("&"))}else history.replaceState(null,"",".")},MM.UI.Backend=Object.create(MM.Repo),MM.UI.Backend.init=function(t){this._backend=MM.Backend.getById(this.id),this._mode="",this._prefix="mm.app."+this.id+".",this._node=document.querySelector("#"+this.id),this._cancel=this._node.querySelector(".cancel"),this._cancel.addEventListener("click",this),this._go=this._node.querySelector(".go"),this._go.addEventListener("click",this),t.appendChild(this._backend.buildOption())},MM.UI.Backend.reset=function(){this._backend.reset()},MM.UI.Backend.setState=function(t){};MM.UI.Backend.getState=function(){return null};MM.UI.Backend.handleEvent=function(t){switch(t.target){case this._cancel:MM.App.io.hide();break;case this._go:this._action()}},MM.UI.Backend.save=function(){},MM.UI.Backend.load=function(){},MM.UI.Backend.show=function(t){this._mode=t,this._go.innerHTML=t.charAt(0).toUpperCase()+t.substring(1);var e=this._node.querySelectorAll("[data-for]");[].concat.apply([],e).forEach(function(t){t.style.display="none"});var i=this._node.querySelectorAll("[data-for~="+t+"]");[].concat.apply([],i).forEach(function(t){t.style.display=""}),this._go.focus()},MM.UI.Backend._action=function(){switch(this._mode){case"save":this.save();break;case"load":this.load()}},MM.UI.Backend._saveDone=function(){MM.App.setThrobber(!1),MM.publish("save-done",this)},MM.UI.Backend._loadDone=function(t){MM.App.setThrobber(!1);try{MM.App.setMap(MM.Map.fromJSON(t)),MM.publish("load-done",this)}catch(t){this._error(t)}},MM.UI.Backend._error=function(t){MM.App.setThrobber(!1),alert("IO error: "+t.message)},MM.UI.Backend._buildList=function(t,e){var i=[];for(var n in t)i.push({id:n,name:t[n]});i.sort(function(t,e){return t.name.localeCompare(e.name)}),i.forEach(function(t){var i=document.createElement("option");i.value=t.id,i.innerHTML=t.name,e.appendChild(i)})},MM.UI.Backend.File=Object.create(MM.UI.Backend,{id:{value:"file"}}),MM.UI.Backend.File.init=function(t){MM.UI.Backend.init.call(this,t),this._format=this._node.querySelector(".format"),this._format.appendChild(MM.Format.JSON.buildOption()),this._format.appendChild(MM.Format.FreeMind.buildOption()),this._format.appendChild(MM.Format.MMA.buildOption()),this._format.appendChild(MM.Format.Mup.buildOption()),this._format.appendChild(MM.Format.Plaintext.buildOption()),this._format.value=localStorage.getItem(this._prefix+"format")||MM.Format.JSON.id},MM.UI.Backend.File.show=function(t){MM.UI.Backend.show.call(this,t),this._go.innerHTML="save"==t?"Save":"Browse"},MM.UI.Backend.File._action=function(){localStorage.setItem(this._prefix+"format",this._format.value),MM.UI.Backend._action.call(this)},MM.UI.Backend.File.save=function(){var t=MM.Format.getById(this._format.value),e=MM.App.map.toJSON(),i=t.to(e),n=MM.App.map.getName()+"."+t.extension;this._backend.save(i,n).then(this._saveDone.bind(this),this._error.bind(this))},MM.UI.Backend.File.load=function(){this._backend.load().then(this._loadDone.bind(this),this._error.bind(this))},MM.UI.Backend.File._loadDone=function(t){try{var e=MM.Format.getByName(t.name)||MM.Format.JSON,i=e.from(t.data)}catch(t){this._error(t)}MM.UI.Backend._loadDone.call(this,i)},MM.UI.Backend.WebDAV=Object.create(MM.UI.Backend,{id:{value:"webdav"}}),MM.UI.Backend.WebDAV.init=function(t){MM.UI.Backend.init.call(this,t),this._url=this._node.querySelector(".url"),this._url.value=localStorage.getItem(this._prefix+"url")||"",this._current=""},MM.UI.Backend.WebDAV.getState=function(){var t={url:this._current};return t},MM.UI.Backend.WebDAV.setState=function(t){this._load(t.url)},MM.UI.Backend.WebDAV.save=function(){MM.App.setThrobber(!0);var t=MM.App.map,e=this._url.value;localStorage.setItem(this._prefix+"url",e),e.match(/\.mymind$/)||("/"!=e.charAt(e.length-1)&&(e+="/"),e+=t.getName()+"."+MM.Format.JSON.extension),this._current=e;var i=t.toJSON(),n=MM.Format.JSON.to(i);this._backend.save(n,e).then(this._saveDone.bind(this),this._error.bind(this))},MM.UI.Backend.WebDAV.load=function(){this._load(this._url.value)},MM.UI.Backend.WebDAV._load=function(t){this._current=t,MM.App.setThrobber(!0);var e=t.lastIndexOf("/");this._url.value=t.substring(0,e),localStorage.setItem(this._prefix+"url",this._url.value),this._backend.load(t).then(this._loadDone.bind(this),this._error.bind(this))},MM.UI.Backend.WebDAV._loadDone=function(t){try{var e=MM.Format.JSON.from(t)}catch(t){this._error(t)}MM.UI.Backend._loadDone.call(this,e)},MM.UI.Backend.Image=Object.create(MM.UI.Backend,{id:{value:"image"}}),MM.UI.Backend.Image.save=function(){var t=MM.App.map.getName(),e=MM.App.map.toJSON(),i=MM.Format.JSON.to(e);this._backend.save(i,t)},MM.UI.Backend.Image.load=null,MM.UI.Backend.Local=Object.create(MM.UI.Backend,{id:{value:"local"}}),MM.UI.Backend.Local.init=function(t){MM.UI.Backend.init.call(this,t),this._list=this._node.querySelector(".list"),this._remove=this._node.querySelector(".remove"),this._remove.addEventListener("click",this)},MM.UI.Backend.Local.handleEvent=function(t){switch(MM.UI.Backend.handleEvent.call(this,t),t.target){case this._remove:var e=this._list.value;if(!e)break;this._backend.remove(e),this.show(this._mode)}},MM.UI.Backend.Local.show=function(t){if(MM.UI.Backend.show.call(this,t),this._go.disabled=!1,"load"==t){var e=this._backend.list();if(this._list.innerHTML="",Object.keys(e).length)this._go.disabled=!1,this._remove.disabled=!1,this._buildList(e,this._list);else{this._go.disabled=!0,this._remove.disabled=!0;var i=document.createElement("option");i.innerHTML="(no maps saved)",this._list.appendChild(i)}}},MM.UI.Backend.Local.setState=function(t){this._load(t.id)},MM.UI.Backend.Local.getState=function(){var t={b:this.id,id:MM.App.map.getId()};return t},MM.UI.Backend.Local.save=function(){var t=MM.App.map.toJSON(),e=MM.Format.JSON.to(t);try{this._backend.save(e,MM.App.map.getId(),MM.App.map.getName()),this._saveDone()}catch(t){this._error(t)}},MM.UI.Backend.Local.load=function(){this._load(this._list.value)},MM.UI.Backend.Local._load=function(t){try{var e=this._backend.load(t),i=MM.Format.JSON.from(e);this._loadDone(i)}catch(t){this._error(t)}},MM.UI.Backend.Firebase=Object.create(MM.UI.Backend,{id:{value:"firebase"}}),MM.UI.Backend.Firebase.init=function(t){MM.UI.Backend.init.call(this,t),this._online=!1,this._itemChangeTimeout=null,this._list=this._node.querySelector(".list"),this._server=this._node.querySelector(".server"),this._server.value=localStorage.getItem(this._prefix+"server")||"my-mind",this._auth=this._node.querySelector(".auth"),this._auth.value=localStorage.getItem(this._prefix+"auth")||"",this._remove=this._node.querySelector(".remove"),this._remove.addEventListener("click",this),this._go.disabled=!1,MM.subscribe("firebase-list",this),MM.subscribe("firebase-change",this)},MM.UI.Backend.Firebase.setState=function(t){this._connect(t.s,t.a).then(this._load.bind(this,t.id),this._error.bind(this))},MM.UI.Backend.Firebase.getState=function(){var t={id:MM.App.map.getId(),b:this.id,s:this._server.value};return this._auth.value&&(t.a=this._auth.value),t},MM.UI.Backend.Firebase.show=function(t){MM.UI.Backend.show.call(this,t),this._sync()},MM.UI.Backend.Firebase.handleEvent=function(t){switch(MM.UI.Backend.handleEvent.call(this,t),t.target){case this._remove:var e=this._list.value;if(!e)break;MM.App.setThrobber(!0),this._backend.remove(e).then(function(){MM.App.setThrobber(!1)},this._error.bind(this))}},MM.UI.Backend.Firebase.handleMessage=function(t,e,i){switch(t){case"firebase-list":if(this._list.innerHTML="",Object.keys(i).length)this._buildList(i,this._list);else{var n=document.createElement("option");n.innerHTML="(no maps saved)",this._list.appendChild(n)}this._sync();break;case"firebase-change":i?(MM.unsubscribe("item-change",this),MM.App.map.mergeWith(i),MM.subscribe("item-change",this)):console.log("remote data disappeared");break;case"item-change":this._itemChangeTimeout&&clearTimeout(this._itemChangeTimeout),this._itemChangeTimeout=setTimeout(this._itemChange.bind(this),200)}},MM.UI.Backend.Firebase.reset=function(){this._backend.reset(),MM.unsubscribe("item-change",this)},MM.UI.Backend.Firebase._itemChange=function(){var t=MM.App.map;this._backend.mergeWith(t.toJSON(),t.getName())},MM.UI.Backend.Firebase._action=function(){return this._online?void MM.UI.Backend._action.call(this):void this._connect(this._server.value,this._auth.value)},MM.UI.Backend.Firebase.save=function(){MM.App.setThrobber(!0);var t=MM.App.map;this._backend.save(t.toJSON(),t.getId(),t.getName()).then(this._saveDone.bind(this),this._error.bind(this))},MM.UI.Backend.Firebase.load=function(){this._load(this._list.value)},MM.UI.Backend.Firebase._load=function(t){MM.App.setThrobber(!0),this._backend.load(t).then(this._loadDone.bind(this),this._error.bind(this))},MM.UI.Backend.Firebase._connect=function(t,e){var i=new Promise;return this._server.value=t,this._auth.value=e,this._server.disabled=!0,this._auth.disabled=!0,localStorage.setItem(this._prefix+"server",t),localStorage.setItem(this._prefix+"auth",e||""),this._go.disabled=!0,MM.App.setThrobber(!0),this._backend.connect(t,e).then(function(){this._connected(),i.fulfill()}.bind(this),i.reject.bind(i)),i},MM.UI.Backend.Firebase._connected=function(){MM.App.setThrobber(!1),this._online=!0,this._sync()},MM.UI.Backend.Firebase._sync=function(){return this._online?(this._go.disabled=!1,"load"!=this._mode||this._list.value||(this._go.disabled=!0),void(this._go.innerHTML=this._mode.charAt(0).toUpperCase()+this._mode.substring(1))):void(this._go.innerHTML="Connect")},MM.UI.Backend.Firebase._loadDone=function(){MM.subscribe("item-change",this),MM.UI.Backend._loadDone.apply(this,arguments)},MM.UI.Backend.Firebase._saveDone=function(){MM.subscribe("item-change",this),MM.UI.Backend._saveDone.apply(this,arguments)},MM.UI.Backend.GDrive=Object.create(MM.UI.Backend,{id:{value:"gdrive"}}),MM.UI.Backend.GDrive.init=function(t){MM.UI.Backend.init.call(this,t),this._format=this._node.querySelector(".format"),this._format.appendChild(MM.Format.JSON.buildOption()),this._format.appendChild(MM.Format.FreeMind.buildOption()),this._format.appendChild(MM.Format.MMA.buildOption()),this._format.appendChild(MM.Format.Mup.buildOption()),this._format.appendChild(MM.Format.Plaintext.buildOption()),this._format.value=localStorage.getItem(this._prefix+"format")||MM.Format.JSON.id},MM.UI.Backend.GDrive.save=function(){MM.App.setThrobber(!0);var t=MM.Format.getById(this._format.value),e=MM.App.map.toJSON(),i=t.to(e),n=MM.App.map.getName(),o="text/plain";t.mime?o=t.mime:n+="."+t.extension,this._backend.save(i,n,o).then(this._saveDone.bind(this),this._error.bind(this))},MM.UI.Backend.GDrive.load=function(){MM.App.setThrobber(!0),this._backend.pick().then(this._picked.bind(this),this._error.bind(this))},MM.UI.Backend.GDrive._picked=function(t){MM.App.setThrobber(!1),t&&(MM.App.setThrobber(!0),this._backend.load(t).then(this._loadDone.bind(this),this._error.bind(this)))},MM.UI.Backend.GDrive.setState=function(t){this._picked(t.id)},MM.UI.Backend.GDrive.getState=function(){var t={b:this.id,id:this._backend.fileId};return t},MM.UI.Backend.GDrive._loadDone=function(t){try{var e=MM.Format.getByMime(t.mime)||MM.Format.getByName(t.name)||MM.Format.JSON,i=e.from(t.data)}catch(t){this._error(t)}MM.UI.Backend._loadDone.call(this,i)},MM.Mouse={TOUCH_DELAY:500,_port:null,_cursor:[0,0],_pos:[0,0],_mode:"",_item:null,_ghost:null,_oldDragState:null,_touchTimeout:null},MM.Mouse.init=function(t){this._port=t,this._port.addEventListener("touchstart",this),this._port.addEventListener("mousedown",this),this._port.addEventListener("click",this),this._port.addEventListener("dblclick",this),this._port.addEventListener("wheel",this),this._port.addEventListener("mousewheel",this),this._port.addEventListener("contextmenu",this)},MM.Mouse.handleEvent=function(t){switch(t.type){case"click":var e=MM.App.map.getItemFor(t.target);if(MM.App.editing&&e==MM.App.current)return;e&&MM.App.select(e);break;case"dblclick":var e=MM.App.map.getItemFor(t.target);e&&MM.Command.Edit.execute();break;case"contextmenu":this._endDrag(),t.preventDefault();var e=MM.App.map.getItemFor(t.target);e&&MM.App.select(e),MM.Menu.open(t.clientX,t.clientY);break;case"touchstart":if(t.touches.length>1)return;t.clientX=t.touches[0].clientX,t.clientY=t.touches[0].clientY;case"mousedown":var e=MM.App.map.getItemFor(t.target);if(MM.App.editing){if(e==MM.App.current)return;MM.Command.Finish.execute()}"mousedown"==t.type&&t.preventDefault(),"touchstart"==t.type&&(this._touchTimeout=setTimeout(function(){e&&MM.App.select(e),MM.Menu.open(t.clientX,t.clientY)},this.TOUCH_DELAY)),this._startDrag(t,e);break;case"touchmove":if(t.touches.length>1)return;t.clientX=t.touches[0].clientX,t.clientY=t.touches[0].clientY,clearTimeout(this._touchTimeout);case"mousemove":this._processDrag(t);break;case"touchend":clearTimeout(this._touchTimeout);case"mouseup":this._endDrag();break;case"wheel":case"mousewheel":var i=0;t.wheelDelta&&(t.wheelDelta<0?i=-1:t.wheelDelta>0&&(i=1)),t.deltaY&&(t.deltaY>0?i=-1:t.deltaY<0&&(i=1)),i&&MM.App.adjustFontSize(i)}},MM.Mouse._startDrag=function(t,e){"mousedown"==t.type?(t.preventDefault(),this._port.addEventListener("mousemove",this),this._port.addEventListener("mouseup",this)):(this._port.addEventListener("touchmove",this),this._port.addEventListener("touchend",this)),this._cursor[0]=t.clientX,this._cursor[1]=t.clientY,e&&!e.isRoot()?(this._mode="drag",this._item=e):(this._mode="pan",this._port.style.cursor="move")},MM.Mouse._processDrag=function(t){t.preventDefault();var e=t.clientX-this._cursor[0],i=t.clientY-this._cursor[1];switch(this._cursor[0]=t.clientX,this._cursor[1]=t.clientY,this._mode){case"drag":this._ghost||(this._port.style.cursor="move",this._buildGhost(e,i)),this._moveGhost(e,i);var n=this._computeDragState();this._visualizeDragState(n);break;case"pan":MM.App.map.moveBy(e,i)}},MM.Mouse._endDrag=function(){if(this._port.style.cursor="",this._port.removeEventListener("mousemove",this),this._port.removeEventListener("mouseup",this),"pan"!=this._mode){if(this._ghost){var t=this._computeDragState();this._finishDragDrop(t),this._ghost.parentNode.removeChild(this._ghost),this._ghost=null}this._item=null}},MM.Mouse._buildGhost=function(){var t=this._item.getDOM().content;this._ghost=t.cloneNode(!0),this._ghost.classList.add("ghost"),this._pos[0]=t.offsetLeft,this._pos[1]=t.offsetTop,t.parentNode.appendChild(this._ghost)},MM.Mouse._moveGhost=function(t,e){this._pos[0]+=t,this._pos[1]+=e,this._ghost.style.left=this._pos[0]+"px",this._ghost.style.top=this._pos[1]+"px";this._computeDragState()},MM.Mouse._finishDragDrop=function(t){this._visualizeDragState(null);var e=t.item;switch(t.result){case"append":var i=new MM.Action.MoveItem(this._item,e);break;case"sibling":var n=e.getParent().getChildren().indexOf(e),o=n+("right"==t.direction||"bottom"==t.direction?1:0),i=new MM.Action.MoveItem(this._item,e.getParent(),o,e.getSide());break;default:return}MM.App.action(i)},MM.Mouse._computeDragState=function(){for(var t=this._ghost.getBoundingClientRect(),e=MM.App.map.getClosestItem(t.left+t.width/2,t.top+t.height/2),i=e.item,n={result:"",item:i,direction:""},o=i;!o.isRoot();){if(o==this._item)return n;o=o.getParent()}var a=this._item.getDOM().content.offsetWidth,r=i.getDOM().content.offsetWidth,s=Math.max(a,r),h=this._item.getDOM().content.offsetHeight,l=i.getDOM().content.offsetHeight,c=Math.max(h,l);if(i.isRoot())n.result="append";else if(Math.abs(e.dx)<s&&Math.abs(e.dy)<c)n.result="append";else{n.result="sibling";var d=i.getParent().getLayout().getChildDirection(i);-1*("top"==d||"bottom"==d?e.dx:e.dy);"left"==d||"right"==d?n.direction=e.dy<0?"bottom":"top":n.direction=e.dx<0?"right":"left"}return n},MM.Mouse._visualizeDragState=function(t){if(!this._oldState||!t||this._oldState.item!=t.item||this._oldState.result!=t.result){if(this._oldDragState){var e=this._oldDragState.item,i=e.getDOM().content;i.style.boxShadow=""}if(this._oldDragState=t,t){var e=t.item,i=e.getDOM().content,n=0,o=0,a=5;"sibling"==t.result&&("left"==t.direction&&(n=-1),"right"==t.direction&&(n=1),"top"==t.direction&&(o=-1),"bottom"==t.direction&&(o=1));var r=n||o?-2:2;i.style.boxShadow=n*a+"px "+o*a+"px 2px "+r+"px #000"}}},MM.App={keyboard:null,current:null,editing:!1,history:[],historyIndex:0,portSize:[0,0],map:null,ui:null,io:null,help:null,_port:null,_throbber:null,_drag:{pos:[0,0],item:null,ghost:null},_fontSize:100,action:function(t){return this.historyIndex<this.history.length&&this.history.splice(this.historyIndex,this.history.length-this.historyIndex),this.history.push(t),this.historyIndex++,t.perform(),this},setMap:function(t){this.map&&this.map.hide(),this.history=[],this.historyIndex=0,this.map=t,this.map.show(this._port)},select:function(t){this.current&&this.current!=t&&this.current.deselect(),this.current=t,this.current.select()},adjustFontSize:function(t){this._fontSize=Math.max(30,this._fontSize+10*t),this._port.style.fontSize=this._fontSize+"%",this.map.update(),this.map.ensureItemVisibility(this.current)},handleMessage:function(t,e){switch(t){case"ui-change":this._syncPort();break;case"item-change":e.isRoot()&&e.getMap()==this.map&&(document.title=this.map.getName()+" :: My Mind")}},handleEvent:function(t){switch(t.type){case"resize":this._syncPort();break;case"beforeunload":return t.preventDefault(),""}},setThrobber:function(t){this._throbber.classList[t?"add":"remove"]("visible")},init:function(){this._port=document.querySelector("#port"),this._throbber=document.querySelector("#throbber"),this.ui=new MM.UI,this.io=new MM.UI.IO,this.help=new MM.UI.Help,MM.Tip.init(),MM.Keyboard.init(),MM.Menu.init(this._port),MM.Mouse.init(this._port),MM.Clipboard.init(),window.addEventListener("resize",this),window.addEventListener("beforeunload",this),MM.subscribe("ui-change",this),MM.subscribe("item-change",this),this._syncPort(),this.setMap(new MM.Map)},paint:function(){var t={root:{id:"ujfdpxoz",text:"Generics",layout:"map",children:[{id:"cmetfpcz",text:"WhyUse",side:"right",color:"#e33",children:[{id:"oufzmqvy",text:"Node selection, manipulation"},{id:"hsthllrc",text:"<b>Rich</b> <i>text</i> <strike>editing</strike>"},{id:"spnaifjx",text:'Auto-linkingcc  <a href="http://www.baidu.com">baidu</a>',value:"www.baidu.com"},{id:"meeftorp",text:'werw&nbsp;<a href="http://www.baidu.com">link</a>',children:[{id:"aqsominz",text:'<a href="http://docs.oracle.com/javase/tutorial/java/generics/index.html">link-qq</a><br>'}]},{id:"pphsgpvu",text:"Zooming"},{id:"avzourxv",text:"Shapes"},{id:"bhszysqp",text:"Full keyboard control"},{id:"zcrefcfz",text:"Folding",collapsed:1,children:[{id:"znuvtncs",text:"Collapsing"},{id:"dbbxxzzs",text:"Expanding"}]}]},{id:"nkrfhzwg",text:"Bounded Type Parameters",side:"left",color:"#3e3",children:[{id:"fpbtygky",text:"Multiple backends",children:[{id:"ezwvmtko",text:"Local storage"},{id:"sczzbjgf",text:"Local filesystem"},{id:"megldbuw",text:"Firebase",children:[{id:"krsvhker",text:"Realtime sync"}]},{id:"rmxmrpum",text:"Google Drive"},{id:"eiocvrju",text:"REST DAV-like"}]},{id:"bmatbsiz",text:"Multiple file formats",children:[{id:"lyzyawpn",text:"Native"},{id:"chfwbjrp",text:"Freemind"},{id:"vhsldewc",text:"Mind Architect"},{id:"whmzheiy",text:"MindMup"}]},{id:"hjialeal",text:"Permalinks"}]},{id:"scoyihcg",text:"Generic Types",side:"right",color:"#33e",collapsed:1,children:[{id:"bvfjpmrm",text:"Numerical node values",value:"sum",collapsed:1,children:[{id:"fppldjcr",text:"Constant values",value:3.14},{id:"lhqwyqwq",text:"Functions",value:42}]},{id:"pjqwdjad",text:"Bool node statuses",value:"maybe",status:"computed",children:[{id:"jsrxnhgy",text:"Yes/No",value:"yes",status:"no"},{id:"oqzwbzvf",text:"Auto-propagation to parent",value:"sum",status:"computed",layout:"graph-right",shape:"ellipse"}]},{id:"adqojbln",text:"Variable layouts",layout:"tree-right",children:[{id:"uglsvbbi",text:"Map"},{id:"mvqxmutu",text:"Graph"},{id:"uonrboqe",text:"Tree"}]},{id:"rsruxymh",text:"Infinite undo/redo"},{id:"jaalsyvs",text:"Export to image"}]},{id:"rbahwqul",text:"Generics, Inheritance, Subtypes",side:"left",color:"#d3d",children:[{id:"vcmxdsvj",text:"Custom styles"},{id:"bsddmwik",text:"Custom icons"}]},{id:"vyrpwrps",text:"Generic Methods",side:"right",color:"#3e3"},{id:"bdedvtvw",text:"Type Inference",side:"left",value:"www.baidu.com"},{id:"ttjjryzb",text:"Wildcards",side:"right"},{id:"rpitsjux",text:"Type Erasure",side:"left"}]}};this._port=document.querySelector("#port"),MM.Mouse.init(this._port),window.addEventListener("resize",this),window.addEventListener("beforeunload",this),MM.subscribe("ui-change",this),MM.subscribe("item-change",this),this._syncPort(),this.setMap(MM.Map.fromJSON(t))},_syncPort:function(){this.portSize=[1800,800],this.map&&this.map.ensureItemVisibility(this.current)}};